<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    
    <title>Tsunamori&#39;s blog</title>
    
    
        <meta name="keywords" content="Tsunamori&#39;s blog">
    
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta property="og:type" content="website">
<meta property="og:title" content="Tsunamori&#39;s blog">
<meta property="og:url" content="https://tsunamori.github.io/index.html">
<meta property="og:site_name" content="Tsunamori&#39;s blog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Tsunamori">
<meta name="twitter:card" content="summary">
    

    
        <link rel="alternate" href="/atom.xml" title="Tsunamori&#39;s blog" type="application/atom+xml">
    

    
        <link rel="icon" href="/favicon.ico">
    

    
<link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">

    
<link rel="stylesheet" href="/libs/open-sans/styles.css">

    
<link rel="stylesheet" href="/libs/source-code-pro/styles.css">


    
<link rel="stylesheet" href="/css/style.css">

    
<script src="/libs/jquery/2.1.3/jquery.min.js"></script>

    
<script src="/libs/jquery/plugins/cookie/1.4.1/jquery.cookie.js"></script>

    
    
        
<link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">

    
    
        
<link rel="stylesheet" href="/libs/justified-gallery/justifiedGallery.min.css">

    
    
    
    


    
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    
<meta name="generator" content="Hexo 5.4.0"></head>

<body>
    <div id="container">
        <header id="header">
    <div id="header-main" class="header-inner">
        <div class="outer">
            <a href="/" id="logo">
                <i class="logo"></i>
                <span class="site-title">Tsunamori&#39;s blog</span>
            </a>
            <nav id="main-nav">
                
                    <a class="main-nav-link" href="/">首页</a>
                
                    <a class="main-nav-link" href="/archives">归档</a>
                
                    <a class="main-nav-link" href="/categories">分类</a>
                
                    <a class="main-nav-link" href="/tags">标签</a>
                
                    <a class="main-nav-link" href="/about">关于</a>
                
            </nav>
            
                
                <nav id="sub-nav">
                    <div class="profile" id="profile-nav">
                        <a id="profile-anchor" href="javascript:;">
                            <img class="avatar" src="https://www.gravatar.com/avatar/bf0a499c8b2705f83e63c534d6cd38a2">
                            <i class="fa fa-caret-down"></i>
                        </a>
                    </div>
                </nav>
            
            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Search">
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="Type something...">
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>


</div>
        </div>
    </div>
    <div id="main-nav-mobile" class="header-sub header-inner">
        <table class="menu outer">
            <tr>
                
                    <td><a class="main-nav-link" href="/">首页</a></td>
                
                    <td><a class="main-nav-link" href="/archives">归档</a></td>
                
                    <td><a class="main-nav-link" href="/categories">分类</a></td>
                
                    <td><a class="main-nav-link" href="/tags">标签</a></td>
                
                    <td><a class="main-nav-link" href="/about">关于</a></td>
                
                <td>
                    
    <div class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Search">
    </div>

                </td>
            </tr>
        </table>
    </div>
</header>

        <div class="outer">
            
                

<aside id="profile">
    <div class="inner profile-inner">
        <div class="base-info profile-block">
            <img id="avatar" src="https://www.gravatar.com/avatar/bf0a499c8b2705f83e63c534d6cd38a2?s=128">
            <h2 id="name">Tsunamori</h2>
            <h3 id="title">The green hat hacker</h3>
            <span id="location"><i class="fa fa-map-marker"></i>Moon the other side</span>
            <a id="follow" target="_blank" href="https://github.com/Tsunamori/" rel="external nofollow noopener noreferrer">FOLLOW</a>
        </div>
        <div class="article-info profile-block">
            <div class="article-info-block">
                38
                <span>posts</span>
            </div>
            <div class="article-info-block">
                11
                <span>tags</span>
            </div>
        </div>
        
        <div class="profile-block social-links">
            <table>
                <tr>
                    
                    
                    <td>
                        <a href="https://github.com/Tsunamori" target="_blank" title="github" class="tooltip" rel="external nofollow noopener noreferrer">
                            <i class="fa fa-github"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="/atom.xml" target="_blank" title="rss" class="tooltip">
                            <i class="fa fa-rss"></i>
                        </a>
                    </td>
                    
                </tr>
            </table>
        </div>
        
    </div>
</aside>

            
            
                <aside id="sidebar">
   
        
    <div class="widget-wrap" id="categories">
        <h3 class="widget-title">
            <span>categories</span>
            &nbsp;
            <a id="allExpand" href="#">
                <i class="fa fa-angle-double-down fa-2x"></i>
            </a>
        </h3>
        
        
        
         <ul class="unstyled" id="tree"> 
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            100 Cyber security
                        </a>
                         <ul class="unstyled" id="tree"> 
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            140 Code review 代码审计
                        </a>
                         <ul class="unstyled" id="tree"> 
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            149 Notes
                        </a>
                         <ul class="unstyled" id="tree">  <li class="file"><a href="/wiki/Note-JAVA%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1-%E5%85%A5%E9%97%A8%E7%AF%87/">note_JAVA代码审计-入门篇</a></li>  </ul> 
                    </li> 
                     </ul> 
                    </li> 
                     </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            100 Web security
                        </a>
                         <ul class="unstyled" id="tree"> 
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            110 Bug bounty
                        </a>
                         <ul class="unstyled" id="tree"> 
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            111 Ideas/WP
                        </a>
                         <ul class="unstyled" id="tree">  <li class="file"><a href="/wiki/File-upload-bypass_%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/">File upload bypass</a></li>  <li class="file"><a href="/wiki/JWT-attack/">JWT attack</a></li>  <li class="file"><a href="/wiki/SSRF/">SSRF</a></li>  <li class="file"><a href="/wiki/SSTI/">SSTI</a></li>  <li class="file"><a href="/wiki/Sensitive-info-leaks/">敏感信息泄漏</a></li>  <li class="file"><a href="/wiki/Subdomain-takeover/">Subdomain takeover</a></li>  <li class="file"><a href="/wiki/XSS/">XSS</a></li>  <li class="file"><a href="/wiki/XXE/">XXE</a></li>  <li class="file"><a href="/wiki/%E8%BF%91%E6%BA%90%E6%B8%97%E9%80%8F/">近源渗透</a></li>  <li class="file"><a href="/wiki/Web-cache-posioning/">Web-cache-posioning</a></li>  <li class="file"><a href="/wiki/%E5%81%B7%E5%AD%A6%E7%9A%84%E6%B8%97%E9%80%8F%E5%B0%8Ftips/">偶然学到的渗透小tips</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            119 Notes
                        </a>
                         <ul class="unstyled" id="tree">  <li class="file"><a href="/wiki/Notes_HowToHunt-md/">Notes for HowToHunt.md</a></li>  </ul> 
                    </li> 
                     </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            120 CTF
                        </a>
                         <ul class="unstyled" id="tree"> 
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            121 Web
                        </a>
                         <ul class="unstyled" id="tree">  <li class="file"><a href="/wiki/CTF_PHP-RCE/">CTF PHP-RCE</a></li>  <li class="file"><a href="/wiki/CTF_PHP/">CTF PHP</a></li>  <li class="file"><a href="/wiki/CTF_back-up-logs/">CTF back-up-logs</a></li>  <li class="file"><a href="/wiki/CTF_MD5/">CTF MD5</a></li>  <li class="file"><a href="/wiki/CTF_SQLI/">CTF SQLI</a></li>  <li class="file"><a href="/wiki/WP-BUUCTF-Web/">WP-BUUCTF-Web</a></li>  <li class="file"><a href="/wiki/WP-Bugku-Web/">WP-BugKu-Web</a></li>  <li class="file"><a href="/wiki/WP-CTFHub-Web/">CTFHub web</a></li>  <li class="file"><a href="/wiki/JavaScript-%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/">JavaScript-原型链污染</a></li>  <li class="file"><a href="/wiki/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">PHP反序列化</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            122 Crypto
                        </a>
                         <ul class="unstyled" id="tree">  <li class="file"><a href="/wiki/WP-Bugku-Crypto/">WP-Bugku-Crypto</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            123 Misc
                        </a>
                         <ul class="unstyled" id="tree">  <li class="file"><a href="/wiki/WP-Bugku-Misc/">WP-Bugku-Misc</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            129 Notes
                        </a>
                         <ul class="unstyled" id="tree">  <li class="file"><a href="/wiki/Notes_0-to-1-the-road-of-CTFer_1/">0 to 1 the road of CTFer 第一章 Web入门</a></li>  </ul> 
                    </li> 
                     <li class="file"><a href="/wiki/CTF_%E9%94%99%E9%A2%98%E9%9B%86/">错题wp集</a></li>  <li class="file"><a href="/wiki/CTF-Tools/">CTF_Tools</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            140 Code review/代码审计
                        </a>
                         <ul class="unstyled" id="tree">  <li class="file"><a href="/wiki/%E8%AF%95%E7%8E%A9Game-of-hacks/">Game of hacks 试玩</a></li>  <li class="file"><a href="/wiki/Notes_%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1-%E4%BC%81%E4%B8%9A%E7%BA%A7web%E4%BB%A3%E7%A0%81%E5%AE%89%E5%85%A8%E7%BB%93%E6%9E%84/">代码审计 企业级web代码安全结构</a></li>  </ul> 
                    </li> 
                     <li class="file"><a href="/wiki/useful-books/">useful sources</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            300 PWN/Reverse
                        </a>
                         <ul class="unstyled" id="tree"> 
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            320 CTF
                        </a>
                         <ul class="unstyled" id="tree"> 
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            312 Reverse
                        </a>
                         <ul class="unstyled" id="tree">  <li class="file"><a href="/wiki/WP-Bugku-Reverse/">WP-Bugku-Reverse</a></li>  </ul> 
                    </li> 
                     </ul> 
                    </li> 
                     </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            400 ICS security
                        </a>
                         <ul class="unstyled" id="tree">  <li class="file"><a href="/wiki/%E5%B7%A5%E6%8E%A7%E5%AE%89%E5%85%A8/">工控安全</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            500 IoT security
                        </a>
                         <ul class="unstyled" id="tree"> 
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            510 Automotive security
                        </a>
                         <ul class="unstyled" id="tree">  <li class="file"><a href="/wiki/%E8%BD%A6%E8%81%94%E7%BD%91%E5%AE%89%E5%85%A8/">车联网安全</a></li>  </ul> 
                    </li> 
                     </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            600 随便叨叨
                        </a>
                         <ul class="unstyled" id="tree">  <li class="file"><a href="/wiki/%E7%8E%B0%E9%98%B6%E6%AE%B5%E5%AF%B9blog%E7%9A%84%E8%A7%84%E5%88%92%E6%80%9D%E8%80%83/">现阶段对blog的规划思考</a></li>  <li class="file"><a href="/wiki/kali%E7%9A%84VPN%E4%BB%A3%E7%90%86%E8%BD%AF%E4%BB%B6%E9%80%89%E6%8B%A9/">在kali上安装clash/V2raya的教程</a></li>  <li class="file"><a href="/wiki/blog%E9%87%8D%E6%9E%84%E5%95%A6/">blog重构啦！</a></li>  <li class="file"><a href="/wiki/%E4%B8%80%E6%AC%A1%E5%B7%AE%E7%82%B9%E7%BF%BB%E8%BD%A6%E7%9A%84v2raya%E7%89%88%E6%9C%AC%E6%9B%B4%E6%96%B0%E7%BB%8F%E5%8E%86/">一次差点翻车的kali v2raya版本更新经历</a></li>  </ul> 
                    </li> 
                     </ul> 
    </div>
    <script>
        $(document).ready(function() {
            var iconFolderOpenClass  = 'fa-folder-open';
            var iconFolderCloseClass = 'fa-folder';
            var iconAllExpandClass = 'fa-angle-double-down';
            var iconAllPackClass = 'fa-angle-double-up';
            // Handle directory-tree expansion:
            // 左键单独展开目录
            $(document).on('click', '#categories a[data-role="directory"]', function (event) {
                event.preventDefault();

                var icon = $(this).children('.fa');
                var expanded = icon.hasClass(iconFolderOpenClass);
                var subtree = $(this).siblings('ul');
                icon.removeClass(iconFolderOpenClass).removeClass(iconFolderCloseClass);
                if (expanded) {
                    if (typeof subtree != 'undefined') {
                        subtree.slideUp({ duration: 100 });
                    }
                    icon.addClass(iconFolderCloseClass);
                } else {
                    if (typeof subtree != 'undefined') {
                        subtree.slideDown({ duration: 100 });
                    }
                    icon.addClass(iconFolderOpenClass);
                }
            });
            // 右键展开下属所有目录
            $('#categories a[data-role="directory"]').bind("contextmenu", function(event){
                event.preventDefault();
                
                var icon = $(this).children('.fa');
                var expanded = icon.hasClass(iconFolderOpenClass);
                var listNode = $(this).siblings('ul');
                var subtrees = $.merge(listNode.find('li ul'), listNode);
                var icons = $.merge(listNode.find('.fa'), icon);
                icons.removeClass(iconFolderOpenClass).removeClass(iconFolderCloseClass);
                if(expanded) {
                    subtrees.slideUp({ duration: 100 });
                    icons.addClass(iconFolderCloseClass);
                } else {
                    subtrees.slideDown({ duration: 100 });
                    icons.addClass(iconFolderOpenClass);
                }
            })
            // 展开关闭所有目录按钮
            $(document).on('click', '#allExpand', function (event) {
                event.preventDefault();
                
                var icon = $(this).children('.fa');
                var expanded = icon.hasClass(iconAllExpandClass);
                icon.removeClass(iconAllExpandClass).removeClass(iconAllPackClass);
                if(expanded) {
                    $('#sidebar .fa.fa-folder').removeClass('fa-folder').addClass('fa-folder-open')
                    $('#categories li ul').slideDown({ duration: 100 });
                    icon.addClass(iconAllPackClass);
                } else {
                    $('#sidebar .fa.fa-folder-open').removeClass('fa-folder-open').addClass('fa-folder')
                    $('#categories li ul').slideUp({ duration: 100 });
                    icon.addClass(iconAllExpandClass);
                }
            });  
        });
    </script>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title"><span>archives</span></h3>
        <div class="widget">
            <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/02/">February 2023</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/01/">January 2023</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/09/">September 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">April 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/02/">February 2022</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">December 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/09/">September 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">July 2021</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/06/">June 2021</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">May 2021</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">April 2021</a><span class="archive-list-count">21</span></li></ul>
        </div>
    </div>

    
    <div id="toTop" class="fa fa-angle-up"></div>
</aside>
            
            <section id="main">
        <article id="post-一次差点翻车的v2raya版本更新经历" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
                    <div class="article-meta">
                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/600-%E9%9A%8F%E4%BE%BF%E5%8F%A8%E5%8F%A8/">600 随便叨叨</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link-link" href="/tags/%E8%B8%A9%E5%9D%91%E8%AE%B0%E5%BD%95/" rel="tag">踩坑记录</a>
    </div>

                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/wiki/%E4%B8%80%E6%AC%A1%E5%B7%AE%E7%82%B9%E7%BF%BB%E8%BD%A6%E7%9A%84v2raya%E7%89%88%E6%9C%AC%E6%9B%B4%E6%96%B0%E7%BB%8F%E5%8E%86/">
            <time datetime="2023-02-13T16:09:05.000Z" itemprop="datePublished">2023-02-14</time>
        </a>
    </div>


                        
                            <i class="fa fa-bar-chart"></i>
                            <span id="busuanzi_container_site_pv"><span id="busuanzi_value_page_pv"></span></span>    
                        
                        
                            <div class="article-meta-button">
                                <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/Tsunamori/Wiki-site/raw/writing/source/_posts/一次差点翻车的v2raya版本更新经历.md"> Source </a>
                            </div>
                            <div class="article-meta-button">
                                <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/Tsunamori/Wiki-site/edit/writing/source/_posts/一次差点翻车的v2raya版本更新经历.md"> Edit </a>
                            </div>
                            <div class="article-meta-button">
                                <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/Tsunamori/Wiki-site/commits/writing/source/_posts/一次差点翻车的v2raya版本更新经历.md"> History </a>
                            </div>
                        
                    </div>
                
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/wiki/%E4%B8%80%E6%AC%A1%E5%B7%AE%E7%82%B9%E7%BF%BB%E8%BD%A6%E7%9A%84v2raya%E7%89%88%E6%9C%AC%E6%9B%B4%E6%96%B0%E7%BB%8F%E5%8E%86/">一次差点翻车的kali v2raya版本更新经历</a>
        </h1>
    

            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
        
            
        
        
            <p>事情的起因是这样的，我在公司和家里各有一个kali虚拟机，很多新工具骚操作都是先在公司机上跑过觉得好用再回家搞一遍。<br>由于一些历史原因，我的kali装了v2raya做代理之后并没有跟随apt-get一起更新版本，所以跑了很久的1.5版本。后来发现2.x版本有了负载均衡加上一些其它优化，比较心动，遂更新了一遍，没想到第二遍在家做的时候险些翻车。</p>
<p>正常的更新路线大抵是这样的：参考<a target="_blank" rel="external nofollow noopener noreferrer" href="https://v2raya.org/en/docs/prologue/installation/debian/">官方文档</a>，由于我不打算跟随最新版本一起更新，所以使用的是下载deb安装包的方式更新。以下是正确的操作步骤：</p>
<ol>
<li>下载最新deb<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/v2rayA/v2rayA/releases">安装包</a> </li>
<li>使用官方推荐脚本更新xray-core <code>curl -Ls https://mirrors.v2raya.org/go.sh | sudo bash</code></li>
<li>apt安装deb包</li>
</ol>
<p>但是，因为一些失误，我这里是先更新了v2raya版本没有更新xray-core，导致新版本v2raya无法运行，报错core版本低。也就是说，我翻不了墙，除非更新core版本，但官方脚本又要翻墙运行。。。</p>
<p>当然，这里其实还是尝试了用物理机直接下好core包丢进虚拟机，但由于众所周知的vmtools兼容性问题，这里丢不进来，哈哈哈（以及送给大家一个我平时用着挺好但今天没能解决问题的激活vmtools的方式：控制台直接输入<code>usr/bin/vmware-user</code>）</p>
<p>vmtools的问题晚点再说，我又换了一个思路，如果你有看过我之前发的内容，那么你会知道我的物理机-windows是用了clash for windows（很遗憾，是没有tun模式的老版本）。那么如何让clash for windows代理我的kali虚拟机流量呢？</p>
<p>闲言少叙，我还要赶紧睡觉，总之，clash开启<code>allow LAN</code>选项，物理机端打开控制台获取对外网卡IP，虚拟机网络配置不确定有没有影响，我这里是保持桥接。clash如果没有更改过端口的话应该是默认7890。（当然如果你是有tun模式的clash好像是可以直接开启就行）</p>
<p>这样我们就拿到了proxy的地址：<code>物理机ip:7890</code></p>
<p>虚拟机端配网页访问比较简单，不清楚的可以看ref第一个链接。控制台有两种方式，一种是配置bash的proxy，也是同样在ref第一个链接（我印象里这部分内容我之前搞clash for kali的时候踩过坑，需要手动配置的项目有很多，不只是配bash proxy就可以的，感兴趣的可以看另外那篇文章，因为我不是希望永久使用物理机clash来代理虚拟机流量所以我不折腾配置）</p>
<p>另一种配置控制台的方式就是用kali自带的proxychains4。</p>
<p>sudo权限编辑proxychains4配置<code>sudo vi /etc/proxychains4.conf </code>，在最后一行添加<code>socks5 物理机ip 7890</code>，保存关闭。</p>
<p>然后以proxychains运行我们想要的更新core脚本：<code>proxychains curl -Ls https://mirrors.v2raya.org/go.sh | sudo proxychains bash</code>，注意这里因为有个管道符，所以应该在管道符前后两个命令都加上proxychains，以及后面的命令是sudo在前proxychains在后。</p>
<p>于是成功利用物理机clash作为代理更新好了core版本，虚拟机又可以快乐起来了！</p>
<p>ref:</p>
<ol>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.ngui.cc/article/show-586553.html?action=onClick">https://www.ngui.cc/article/show-586553.html?action=onClick</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://blog.csdn.net/weixin_68281676/article/details/125477791#:~:text=%E9%85%8D%E7%BD%AE%20%E6%96%87%E4%BB%B6%E8%B7%AF%E5%BE%84%E4%B8%BA%EF%BC%9A%2Fetc%2F%20proxychains.conf%EF%BC%8C%E5%B0%86%E6%96%87%E4%BB%B6%E6%8B%89%E5%80%92%E6%9C%80%E5%BA%95%E9%83%A8%E3%80%82%20proxychains,%E8%BF%90%E8%A1%8C%E6%96%B9%E6%B3%95%EF%BC%9A%20proxychains%20%2B%20%E7%A8%8B%E5%BA%8F%E3%80%82">https://blog.csdn.net/weixin_68281676/article/details/125477791#:~:text=%E9%85%8D%E7%BD%AE%20%E6%96%87%E4%BB%B6%E8%B7%AF%E5%BE%84%E4%B8%BA%EF%BC%9A%2Fetc%2F%20proxychains.conf%EF%BC%8C%E5%B0%86%E6%96%87%E4%BB%B6%E6%8B%89%E5%80%92%E6%9C%80%E5%BA%95%E9%83%A8%E3%80%82%20proxychains,%E8%BF%90%E8%A1%8C%E6%96%B9%E6%B3%95%EF%BC%9A%20proxychains%20%2B%20%E7%A8%8B%E5%BA%8F%E3%80%82</a></li>
</ol>

            </div>
        
        <footer class="article-footer">
        </footer>
    </div>
</article>






    
        <article id="post-blog重构啦" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
                    <div class="article-meta">
                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/600-%E9%9A%8F%E4%BE%BF%E5%8F%A8%E5%8F%A8/">600 随便叨叨</a>
    </div>

                        
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/wiki/blog%E9%87%8D%E6%9E%84%E5%95%A6/">
            <time datetime="2023-01-29T07:12:35.000Z" itemprop="datePublished">2023-01-29</time>
        </a>
    </div>


                        
                            <i class="fa fa-bar-chart"></i>
                            <span id="busuanzi_container_site_pv"><span id="busuanzi_value_page_pv"></span></span>    
                        
                        
                            <div class="article-meta-button">
                                <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/Tsunamori/Wiki-site/raw/writing/source/_posts/blog重构啦.md"> Source </a>
                            </div>
                            <div class="article-meta-button">
                                <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/Tsunamori/Wiki-site/edit/writing/source/_posts/blog重构啦.md"> Edit </a>
                            </div>
                            <div class="article-meta-button">
                                <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/Tsunamori/Wiki-site/commits/writing/source/_posts/blog重构啦.md"> History </a>
                            </div>
                        
                    </div>
                
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/wiki/blog%E9%87%8D%E6%9E%84%E5%95%A6/">blog重构啦！</a>
        </h1>
    

            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
        
            
        
        
            <p>Hello everybody!</p>
<p>趁着开工不太忙，我把手里的各种笔记整理了一下，准备整合成一个知识库。同样，也重新审视了一下现有的内容，做了一些调整。</p>
<p>之所以很长一段时间没有更新blog，主要是因为一部分笔记没有脱敏处理就没放上来，其次就是某些特定主题的内容，被我直接做成了一个git项目放在了主页。</p>
<p>我思考了一下我对这个博客的定位，决定把它做成一个更加偏向内容产出的地方，可能会看到的有我做的Write up、一些综合性的总结、一些进行中的思考、一些经验性的东西，不只是安全相关。（这么一想可能今后还得不断重构目录以容纳新方向的东西）</p>
<p>大量且主题专一包括很多素材收录的内容，大概率还是会放在我的github上作为单一的项目出现（eg: <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/Tsunamori/AI-drawing-prompts%EF%BC%89">https://github.com/Tsunamori/AI-drawing-prompts）</a></p>
<p>啊顺便说一下22年的一些总结吧。</p>
<p>工作上我自己最喜欢的部分是做了一些风险收敛的研究，写了一些非常落地的风险收敛解决方案。这些内容让我很惊讶的发现了甲方安全运营角度和乙方攻击视角的不同，安全运营最头疼的其实不是‘如何修复漏洞’，而是‘当前修复方案在实际情况中存在一些不对等/无法实现时，如何平衡成本、是否需要修改缓解措施、如何缓解处理效果更好’+‘如何更好更具有性价比的在全部资产上收敛风险’。</p>
<p>在技术上的提升，主要是作为红队实施了一些攻防项目，OSCP虽然没考过但确实学到了很多东西。（啊短时间之内应该不会再考了吧</p>
<p>说到OSCP，在ddl的高压之下，也<del>被迫</del>阅读了不少关于自我提升主题的书籍，实际地应用了一些技巧和思路；尝试了很多个todo APP，终于找到了目前我比较喜欢的一个；尝试了很多种记笔记的方式以及应用，目前也算是找到了最舒适的应用，配置了非常多自定义插件和快捷键调整。</p>
<p>再来说关于23年的。。。展望？</p>
<p>技术上主要方向会是做一些云安全的了解，从攻击技术拓展到安全运营。另外也会看一些数据安全的内容，总之目的都是做安全运营。（这一部分的素材收录大概会放在项目 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/Tsunamori/security-learning-schedule">https://github.com/Tsunamori/security-learning-schedule</a> 里）</p>
<p>除去以上，休闲时间应该会养成并保持定期打HTB的习惯，算是一些复健活动并且<del>我真的非常想过OSCP</del>。</p>
<p>再休闲一些的活动就是读书啦，微信读书22年读了10本，今年目前已经读完2本了，超越去年记录指日可待。以及22年底开始从中图网买纸质书，会放在床头睡前读一段，比较助眠。</p>
<p>游戏的话，steam打折买的巫师3还没动，今年还有王国之泪要玩。</p>
<p>就是这样啦，新年快乐！</p>

            </div>
        
        <footer class="article-footer">
        </footer>
    </div>
</article>






    
        <article id="post-kali的VPN代理软件选择" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
                    <div class="article-meta">
                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/600-%E9%9A%8F%E4%BE%BF%E5%8F%A8%E5%8F%A8/">600 随便叨叨</a>
    </div>

                        
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/wiki/kali%E7%9A%84VPN%E4%BB%A3%E7%90%86%E8%BD%AF%E4%BB%B6%E9%80%89%E6%8B%A9/">
            <time datetime="2022-09-23T02:33:04.000Z" itemprop="datePublished">2022-09-23</time>
        </a>
    </div>


                        
                            <i class="fa fa-bar-chart"></i>
                            <span id="busuanzi_container_site_pv"><span id="busuanzi_value_page_pv"></span></span>    
                        
                        
                            <div class="article-meta-button">
                                <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/Tsunamori/Wiki-site/raw/writing/source/_posts/kali的VPN代理软件选择.md"> Source </a>
                            </div>
                            <div class="article-meta-button">
                                <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/Tsunamori/Wiki-site/edit/writing/source/_posts/kali的VPN代理软件选择.md"> Edit </a>
                            </div>
                            <div class="article-meta-button">
                                <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/Tsunamori/Wiki-site/commits/writing/source/_posts/kali的VPN代理软件选择.md"> History </a>
                            </div>
                        
                    </div>
                
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/wiki/kali%E7%9A%84VPN%E4%BB%A3%E7%90%86%E8%BD%AF%E4%BB%B6%E9%80%89%E6%8B%A9/">在kali上安装clash/V2raya的教程</a>
        </h1>
    

            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
        
            
        
        
            <p>19年写过的东西了，当时被小管家gank文章无了，好在还有备份。这次更新V2raya的时候正好放上来，给自己一个安装指导。</p>
<p>然后，本文仅提供Clash和V2raya的Kali系统对比和安装教程（因为Win的要简单多了）。</p>
<p>先把结论放在最前面，Clash的优点是可以自动切换IP，v2raya要手动切，但个人使用之后感觉Linux端Clash真心不如V2raya，不过win端Clash的舒适度大于V2raya。我自己经过反复踩雷之后选择Kali虚拟机用V2raya，主机Windows用Clash。</p>
<p>当然，Clash的win端想要开全局代理把运行Kali的虚拟机流量代理起来又是另一个很头秃的问题，毕竟Clash创造出来的本意似乎并不是服务于更好的全局代，我至今没能找到简单又完美的开局办法（也可能因为我妥协了换成V2raya for Linux）。</p>
<p>V2ray for win可以直接全局代理搞定虚拟机，但是配置要比Clash麻烦一些。而且出于各种需求，我还是倾向于给Kali自己开代理，主机端就不需要一直开着代理用了。</p>
<p>但从安装在Kali的体验来说，V2raya更适合像我一样，经常从github下个脚本跑的人，毕竟Clash的全局代额外使用了脚本之后在kali控制台内体验仍然不好（再次羡慕Ubuntu的网络全局配置），使用Clash的话往往需要加一条 –proxy x.x.x.x:xxx，还容易不好使。Kali虽然自带proxychains，但一个是配置起来麻烦，另一个是如果用的机场，可能需要多次的手动调整配置文件。</p>
<p>先写Clash，V2raya在下面。</p>
<p>Clash：</p>
<p>下载合适的版本，我在kali2021上用的是clash-linux-amd64-v1.6.0.gz。</p>
<p>解压<code>gzip -d clash-linux-amd64-v1.6.0.gz </code></p>
<p>(注意修改版本号，改成你自己下载的版本)<br>给个权限<br><code>sudo chmod +x ./clash-linux-amd64-v1.6.0</code><br>，这里想把文件名简化一下也可以。（再次注意clash的文件名可能需要改动成你自己拥有的）</p>
<p>运行<br><code>./clash-linux-amd64-v1.6.0</code><br>， 注意Clash默认每次开机后需要手动开启，也就是该命令每次开机你都需要跑一下。</p>
<p>然后路径<br><code>/home/用户名/.config/clash</code><br>下会有自动生成的配置文件，没有.config文件的去view里打开show hidden file。（用户名是你自己设置的啊，会不一样）</p>
<p>这里的两个配置文件要更换，如果你的XXX服务商没有提供配置文件，建议win下装个Clash，配好了再把配置文件拿过来，反正win端Clash也挺好用的，装个不亏。</p>
<p>config.yaml：从win端路径C:\Users\用户名.config\clash\profiles拿到一个多半是<code>数字.yml</code>格式的yaml文件，改名成config.yaml，丢进/home/kali/.config/clash替换原文件。（注意这个yml和yaml的区别）</p>
<p>Country.mmdb：从win端路径C:\Users\用户名.config\clash下拿到Country.mmdb，丢进/home/kali/.config/clash替换原文件。（Users在中文版win里面是<code>用户</code>，用户名就是你的账户名字啦）</p>
<p>重新运行<br>./clash-linux-amd64-v1.6.0<br>（不需要sudo），打开浏览器访问<br><a target="_blank" rel="external nofollow noopener noreferrer" href="http://clash.razord.top/#/proxies">http://clash.razord.top/#/proxies</a><br>看Clash配置，浏览器端口设置<code>HTTP:127.0.0.1:7890, SSL:127.0.0.1:7890, SOCKS_v5:127.0.0.1:7891</code>(preference-&gt;network settings,新版本似乎已经统一到127.0.0.1:7890了,socks_v5要改成7890，具体要看运行clash时候控制台显示什么)，访问外网确定能使。(运行clash的terminal不要关，关了就结束运行了)</p>
<p>那么到这里，问题来了，目前的配置能让你的Kali浏览器访问外网，Clash的作用仅仅是帮你在127.0.0.1:7890开了一个代理通道，但除了浏览器以外的流量想要指向代理就得自己设置。这可就有名堂了，比如控制台、环境变量、apt源、npm源、docker，这些都要自行配置指向代理通道。</p>
<p>如果是造轮子达人可以写个自定义脚本，我等渣渣还是优先找别人的轮子了，指路himanshub16/ProxyMan，一键配置（运行不需要sudo），这个脚本有一处难点，就是它原本是写给linux用，所以kali有些环境变量路径不适配，需要切换至bash让脚本自行适配环境变量再切回来，具体操作为:<br>控制台<br>exec bash<br>进入bash模式，<br>source ~/.bashrc<br>更改bashrc配置，安装ProxyMan脚本<br>./install<br>，配置生效后<br>exec zsh<br>回到zsh模式，<br>proxyman set<br>设置一键配置端口。 （这里有不会用的实在解决不了的再来问我吧，容易遇到的问题种类比较多，具体问题具体分析）</p>
<p>但以上仅能保证脚本内提及的各种控制台、apt源、npm源等一键配置代理，其它你会用到的临时项目都要手动指向代理通道，或者自己手动添加进配置文件or脚本。（或许也有更好的解决办法但是我还是选择v2raya）</p>
<p>V2raya：</p>
<p>Linux版建议使用v2rayA/v2rayA，比直接上原生V2ray好使。</p>
<p>安装方法指路官方文档，照着搞。</p>
<p>v2raya默认开机自启动，省心省力。(注意！现在的1.5.x版本已经不支持默认开机自启动，也不支持软件源更新时自动更新版本了，具体命令去<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/v2rayA/v2rayA/issues/237">这里</a>看)</p>
<p>访问<code>http://localhost:2017/</code>，导入你的XXX服务商生成的配置文件，记得把全局透明代理打开。</p>
<p>设置不会改的就保持默认，我自己开了DNS防劫持(有的时候会出现一些连不上的情况，如果排除是订阅源的问题，我会重新开关一下DNS防劫持)。</p>
<p>总结：写的很稀碎并不保姆，累了（划掉）</p>
<p>之所以大费周张地写了很多Clash内容，只是因为相对来说Clash for Kali的教程还是很少，官方文档也是云里雾里，而且也基本没人提新版本的Kali网络配置没有了全局代理，要么能打开谷歌就算胜利，要么旧版Kali教程来回搬运。偶尔有提到Clash for Linux的，也是打开配置文件挨个手动更改配置代理，这很不cool。</p>
<p>虽然我仍然推荐V2rayA，但或许会有人有一天用的上这些内容。</p>

            </div>
        
        <footer class="article-footer">
        </footer>
    </div>
</article>






    
        <article id="post-现阶段对blog的规划思考" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
                    <div class="article-meta">
                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/600-%E9%9A%8F%E4%BE%BF%E5%8F%A8%E5%8F%A8/">600 随便叨叨</a>
    </div>

                        
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/wiki/%E7%8E%B0%E9%98%B6%E6%AE%B5%E5%AF%B9blog%E7%9A%84%E8%A7%84%E5%88%92%E6%80%9D%E8%80%83/">
            <time datetime="2022-04-01T02:44:05.000Z" itemprop="datePublished">2022-04-01</time>
        </a>
    </div>


                        
                            <i class="fa fa-bar-chart"></i>
                            <span id="busuanzi_container_site_pv"><span id="busuanzi_value_page_pv"></span></span>    
                        
                        
                            <div class="article-meta-button">
                                <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/Tsunamori/Wiki-site/raw/writing/source/_posts/现阶段对blog的规划思考.md"> Source </a>
                            </div>
                            <div class="article-meta-button">
                                <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/Tsunamori/Wiki-site/edit/writing/source/_posts/现阶段对blog的规划思考.md"> Edit </a>
                            </div>
                            <div class="article-meta-button">
                                <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/Tsunamori/Wiki-site/commits/writing/source/_posts/现阶段对blog的规划思考.md"> History </a>
                            </div>
                        
                    </div>
                
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/wiki/%E7%8E%B0%E9%98%B6%E6%AE%B5%E5%AF%B9blog%E7%9A%84%E8%A7%84%E5%88%92%E6%80%9D%E8%80%83/">现阶段对blog的规划思考</a>
        </h1>
    

            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
        
            
        
        
            <p>难得有时间，想整理一下现在的东西。<br>我见过的一些blog，似乎更加的“有人情味”。<br>或者，每一篇是完整的，发出即完成，符合RSS订阅人的需求。<br>有想过，要不要把这些内容迁移出去当知识库，但想了想，如果blog不能作为我自己的知识库来用，那似乎我也用不太上它。<br>我的地盘即我的规则，还是就这样吧。<br>但最一开始的那些从hunter-book收集来的东西，没准要再整理，去符合我自己的一些阅读习惯（主要是纯英文tab不方便阅读，英文特性如此）。<br>也有在私下离线写一些东西，等着完整地发出来。<br>也会想着去写一些更加有“情感波动”的东西出来，比如现在这个。<br>不过更多的时候没有太多值得沉淀的“感情类”文字，有的只是不停的思考。</p>

            </div>
        
        <footer class="article-footer">
        </footer>
    </div>
</article>






    
        <article id="post-PHP反序列化" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
                    <div class="article-meta">
                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/100-Web-security/">100 Web security</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/categories/100-Web-security/120-CTF/">120 CTF</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/categories/100-Web-security/120-CTF/121-Web/">121 Web</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link-link" href="/tags/CTF/" rel="tag">CTF</a>
    </div>

                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/wiki/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">
            <time datetime="2022-02-21T01:59:53.000Z" itemprop="datePublished">2022-02-21</time>
        </a>
    </div>


                        
                            <i class="fa fa-bar-chart"></i>
                            <span id="busuanzi_container_site_pv"><span id="busuanzi_value_page_pv"></span></span>    
                        
                        
                            <div class="article-meta-button">
                                <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/Tsunamori/Wiki-site/raw/writing/source/_posts/PHP反序列化.md"> Source </a>
                            </div>
                            <div class="article-meta-button">
                                <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/Tsunamori/Wiki-site/edit/writing/source/_posts/PHP反序列化.md"> Edit </a>
                            </div>
                            <div class="article-meta-button">
                                <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/Tsunamori/Wiki-site/commits/writing/source/_posts/PHP反序列化.md"> History </a>
                            </div>
                        
                    </div>
                
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/wiki/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">PHP反序列化</a>
        </h1>
    

            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
        
            
        
        
            <h2 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h2><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.freebuf.com/articles/web/266013.html">https://www.freebuf.com/articles/web/266013.html</a> PHP反序列化漏洞的原理及复现</p>

            </div>
        
        <footer class="article-footer">
        </footer>
    </div>
</article>






    
        <article id="post-JavaScript-原型链污染" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
                    <div class="article-meta">
                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/100-Web-security/">100 Web security</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/categories/100-Web-security/120-CTF/">120 CTF</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/categories/100-Web-security/120-CTF/121-Web/">121 Web</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link-link" href="/tags/Summary/" rel="tag">Summary</a>
    </div>

                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/wiki/JavaScript-%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/">
            <time datetime="2022-02-08T17:58:21.000Z" itemprop="datePublished">2022-02-09</time>
        </a>
    </div>


                        
                            <i class="fa fa-bar-chart"></i>
                            <span id="busuanzi_container_site_pv"><span id="busuanzi_value_page_pv"></span></span>    
                        
                        
                            <div class="article-meta-button">
                                <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/Tsunamori/Wiki-site/raw/writing/source/_posts/JavaScript-原型链污染.md"> Source </a>
                            </div>
                            <div class="article-meta-button">
                                <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/Tsunamori/Wiki-site/edit/writing/source/_posts/JavaScript-原型链污染.md"> Edit </a>
                            </div>
                            <div class="article-meta-button">
                                <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/Tsunamori/Wiki-site/commits/writing/source/_posts/JavaScript-原型链污染.md"> History </a>
                            </div>
                        
                    </div>
                
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/wiki/JavaScript-%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/">JavaScript-原型链污染</a>
        </h1>
    

            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
        
            
        
        
            <h1 id="简单的背景介绍"><a href="#简单的背景介绍" class="headerlink" title="简单的背景介绍"></a>简单的背景介绍</h1><h2 id="JavaScript原型链"><a href="#JavaScript原型链" class="headerlink" title="JavaScript原型链"></a>JavaScript原型链</h2><p>JavaScript是动态的，本身不提供一个 <code>class</code> 的实现。即便是在 ES2015/ES6 中引入了 <code>class</code> 关键字，但那也只是语法糖，JavaScript 仍然是基于原型的。</p>
<p>当谈到继承时，JavaScript只有一种结构：对象。每个实例对象（object）都有一个私有属性（称之为 <strong>proto</strong> ）指向它的构造函数的原型对象（prototype）。该原型对象也有一个自己的原型对象（__proto__），层层向上直到一个对象的原型对象为 null。根据定义，null 没有原型，并作为这个原型链中的最后一个环节。</p>
<h2 id="原型链攻击"><a href="#原型链攻击" class="headerlink" title="原型链攻击"></a>原型链攻击</h2><p>实质上是通过解析JSON的方式，将<code>__proto__</code>作为键名而非原型，赋值给对象，从而污染原型链。<br>通常利用<code>对象merge</code>或<code>对象clone（其实内核就是将待操作的对象merge到一个空对象中）</code>的方式控制并操作键名。</p>
<h1 id="学习材料"><a href="#学习材料" class="headerlink" title="学习材料"></a>学习材料</h1><ol>
<li>深入理解JavaScript Prototype 污染攻击 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.leavesongs.com/PENETRATION/javascript-prototype-pollution-attack.html">https://www.leavesongs.com/PENETRATION/javascript-prototype-pollution-attack.html</a></li>
<li>浅析javascript原型链污染攻击 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://xz.aliyun.com/t/7182">https://xz.aliyun.com/t/7182</a></li>
<li>再探 JavaScript 原型链污染到 RCE <a target="_blank" rel="external nofollow noopener noreferrer" href="https://xz.aliyun.com/t/7025">https://xz.aliyun.com/t/7025</a></li>
<li>[Node] child_process.fork 与 env 污染 RCE <a target="_blank" rel="external nofollow noopener noreferrer" href="https://blog.mmf.moe/post/node-fork-proto-env-rce/">https://blog.mmf.moe/post/node-fork-proto-env-rce/</a></li>
<li>从Kibana-RCE对nodejs子进程创建的思考 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://xz.aliyun.com/t/6755">https://xz.aliyun.com/t/6755</a></li>
</ol>
<p>知识点解说和题解还是得先看1，p神太帅了。3是一个RCE拓展，（就是预判太跳跃了，大佬太快我跟不上QAQ）。</p>
<p>关于p神举的原型链污染样例，我自己又写了一下，实际上得到的是这样的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt; let o2 &#x3D; &#123;a:1, __proto__:&#123;b:2&#125;&#125;</span><br><span class="line">&lt; undefined</span><br><span class="line">&gt;&gt; o2</span><br><span class="line">&lt; &#123;…&#125;</span><br><span class="line">	a: 1</span><br><span class="line">	&lt;prototype&gt;: &#123;…&#125;</span><br><span class="line">​​		b: 2</span><br><span class="line">​​		&lt;prototype&gt;: Object &#123; … &#125;</span><br></pre></td></tr></table></figure>

<p>也就是说，o2的__proto__实际上并没能赋上值，而是赋值给了o2的prototype，所以导致o3被赋值null后无法继承b。<br>利用JSON赋值后，得到：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt; let a2 &#x3D;  JSON.parse(&#39;&#123;&quot;a&quot;:1, &quot;__proto__&quot;:&#123;&quot;b&quot;:2&#125;&#125;&#39;)</span><br><span class="line">&lt; undefined</span><br><span class="line">&gt;&gt; a2</span><br><span class="line">&lt; &#123;…&#125;</span><br><span class="line">	__proto__: Object &#123; b: 2 &#125;</span><br><span class="line">	a: 1</span><br><span class="line">	&lt;prototype&gt;: Object &#123; … &#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这个时候a2的__proto__就已经赋上值，改变了指针指向。</p>
<p>第4篇是从node.js漏洞角度来分析，在我看来侧重点还是有些区别，更像进阶内容。</p>
<h1 id="实战分析"><a href="#实战分析" class="headerlink" title="实战分析"></a>实战分析</h1><h2 id="2020-第五空间-hard-node"><a href="#2020-第五空间-hard-node" class="headerlink" title="2020-第五空间-hard_node"></a>2020-第五空间-hard_node</h2><p>这个时候再翻回来看那道题。<br>源码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; app.js</span><br><span class="line">const express &#x3D; require(&#39;express&#39;);</span><br><span class="line">const bodyParser &#x3D; require(&#39;body-parser&#39;);</span><br><span class="line">const proc &#x3D; require(&#39;child_process&#39;);</span><br><span class="line">const request &#x3D; require(&#39;request&#39;);</span><br><span class="line">const ip &#x3D; require(&quot;ip&quot;);</span><br><span class="line">const manage &#x3D; require(&quot;.&#x2F;manage.js&quot;);</span><br><span class="line">const path &#x3D; require(&#39;path&#39;);</span><br><span class="line"></span><br><span class="line">const app &#x3D; express();</span><br><span class="line">app.use(bodyParser.urlencoded(&#123; extended: true &#125;));</span><br><span class="line">app.use(bodyParser.json());</span><br><span class="line"></span><br><span class="line">app.use(express.static(path.join(__dirname, &#39;public&#39;)));</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;stop hackers</span><br><span class="line">const disallowedKeys &#x3D; [</span><br><span class="line">    &#39;__proto__&#39;,</span><br><span class="line">    &#39;prototype&#39;,</span><br><span class="line">    &#39;constructor&#39;,</span><br><span class="line">    &#39;eval&#39;,&#39;proccess&#39;,&#39;root&#39;,&#39;global&#39;,&#39;exec&#39;,&#39;!&#39;,&#39;fs&#39;</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">function isValidPath(segment)&#123;</span><br><span class="line">    disallowedKeys.forEach(evilWord &#x3D;&gt; &#123;</span><br><span class="line">        if(segment.toString().indexOf(evilWord)!&#x3D;&#x3D;-1)&#123;</span><br><span class="line">            return false</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app.post(&#39;&#x2F;add&#39;, (req, res) &#x3D;&gt; &#123;</span><br><span class="line">    let ip &#x3D; req.ip;</span><br><span class="line">    console.log(ip.m);</span><br><span class="line">    if (ip.substr(0, 7) &#x3D;&#x3D; &quot;::ffff:&quot;) &#123;</span><br><span class="line">        ip &#x3D; ip.substr(7)</span><br><span class="line">    &#125;</span><br><span class="line">    console.log(&#96;method:$&#123;req.method&#125;,serverip:$&#123;server_ip&#125;,ip:$&#123;ip&#125;&#96;);</span><br><span class="line"></span><br><span class="line">    if (ip !&#x3D; &#39;127.0.0.1&#39; &amp;&amp; ip !&#x3D; server_ip) &#123;</span><br><span class="line">        res.status(403).send(&#39;Not Edit from Local!&#39;);</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        if(req.body.userName &amp;&amp; req.body.nameVal)&#123;</span><br><span class="line">            let username &#x3D; req.body.userName;</span><br><span class="line">            let nameVal &#x3D; req.body.nameVal;</span><br><span class="line"></span><br><span class="line">            if (!isValidPath(username) || !isValidPath(nameVal)) &#123;</span><br><span class="line">                username &#x3D; &#39;username&#39;;</span><br><span class="line">                nameVal &#x3D; &#39;guest&#39;;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            manage.set(object, username, nameVal);</span><br><span class="line">            console.log(ip.k);</span><br><span class="line">            console.log(object);</span><br><span class="line"></span><br><span class="line">            res.send(&#96;</span><br><span class="line">            &lt;h1&gt;Edit Success&lt;&#x2F;h1&gt;</span><br><span class="line">            &lt;a href&#x3D;&quot;&#x2F;admin&quot;&gt;View Admin Page&lt;&#x2F;a&gt;&#96;)</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            res.send(&#39;param error&#39;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.get(&#39;&#x2F;admin&#39;,(req,res)&#x3D;&gt;&#123;</span><br><span class="line">    if(manage.get(object,&#39;username&#39;,&#39;guest&#39;) &#x3D;&#x3D;&#x3D; &#39;admin&#39;)&#123;</span><br><span class="line">        console.log(&#39;Current User:&#39;+object.username)</span><br><span class="line"></span><br><span class="line">        const child &#x3D; proc.fork(&#96;$&#123;__dirname&#125;&#x2F;public&#x2F;user.js&#96;,[&#39;admin&#39;]);</span><br><span class="line">        child.on(&#39;message&#39;, (body) &#x3D;&gt; &#123;</span><br><span class="line">            res.status(200).send(body);</span><br><span class="line">        &#125;);</span><br><span class="line">        child.on(&#39;close&#39;, (code, signal) &#x3D;&gt; &#123;</span><br><span class="line">            console.log(&#96;subproccess ended with $&#123;signal&#125;&#96;);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        res.status(403).send(&#39;Only Admin Can View this&#39;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.get(&#39;&#x2F;getContent&#39;,(req,res)&#x3D;&gt;&#123;</span><br><span class="line">    res.sendfile(&#96;$&#123;__dirname&#125;&#x2F;public&#x2F;guest.html&#96;);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.get(&#39;&#x2F;&#39;, (req,res) &#x3D;&gt; &#123;</span><br><span class="line">    &#x2F;&#x2F; console.log(req.body)</span><br><span class="line">    let uri &#x3D; req.query.url? req.query.url: &#39;http:&#x2F;&#x2F;127.0.0.1:3000&#x2F;getContent&#39;;</span><br><span class="line">    console.log(uri)</span><br><span class="line"></span><br><span class="line">    try&#123;</span><br><span class="line">        request.get(uri,(err,response,data)&#x3D;&gt;&#123;</span><br><span class="line">            if (!err &amp;&amp; response.statusCode &#x3D;&#x3D; 200) &#123;</span><br><span class="line">                res.send(data);</span><br><span class="line">            &#125;else&#123;</span><br><span class="line">                console.log(err);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;catch(e)&#123;</span><br><span class="line">        console.log(e);</span><br><span class="line">    &#125;finally&#123;</span><br><span class="line">        console.log(&#39;Make Server Continue Running&#39;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">var object &#x3D; &#123;username:&#39;guest&#39;&#125;;</span><br><span class="line">var server_ip &#x3D; ip.address();</span><br><span class="line"></span><br><span class="line">app.listen(3002);</span><br><span class="line">console.log(&#96;$&#123;server_ip&#125; is starting at port 3000&#96;)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; manage.js</span><br><span class="line">const isObj &#x3D; require(&#39;is-obj&#39;);</span><br><span class="line">var manage &#x3D; &#123;</span><br><span class="line">    getPathSegments: function(path) &#123;</span><br><span class="line">        const pathArray &#x3D; path.split(&#39;.&#39;);</span><br><span class="line">        const parts &#x3D; [];</span><br><span class="line">        for (let i &#x3D; 0; i &lt; pathArray.length; i++) &#123;</span><br><span class="line">            let p &#x3D; pathArray[i];</span><br><span class="line">            while (p[p.length - 1] &#x3D;&#x3D;&#x3D; &#39;\\&#39; &amp;&amp; pathArray[i + 1] !&#x3D;&#x3D; undefined) &#123;</span><br><span class="line">                p &#x3D; p.slice(0, -1);</span><br><span class="line">                p +&#x3D; pathArray[++i];</span><br><span class="line">            &#125;</span><br><span class="line">            parts.push(p);</span><br><span class="line">        &#125;</span><br><span class="line">        return parts;</span><br><span class="line">    &#125;,</span><br><span class="line">    get: function(object, path, value) &#123;</span><br><span class="line">        if (!isObj(object) || typeof path !&#x3D;&#x3D; &#39;string&#39;) &#123;</span><br><span class="line">            return value &#x3D;&#x3D;&#x3D; undefined ? object : value;</span><br><span class="line">        &#125;</span><br><span class="line">        const pathArray &#x3D; this.getPathSegments(path);</span><br><span class="line">        for (let i &#x3D; 0; i &lt; pathArray.length; i++) &#123;</span><br><span class="line">            if (!Object.prototype.propertyIsEnumerable.call(object, pathArray[i])) &#123;</span><br><span class="line">                return value;</span><br><span class="line">            &#125;</span><br><span class="line">            object &#x3D; object[pathArray[i]];</span><br><span class="line">            if (object &#x3D;&#x3D;&#x3D; undefined || object &#x3D;&#x3D;&#x3D; null) &#123;</span><br><span class="line">                if (i !&#x3D;&#x3D; pathArray.length - 1) &#123;</span><br><span class="line">                    return value;</span><br><span class="line">                &#125;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return object;</span><br><span class="line">    &#125;,</span><br><span class="line">    set: function(object, path, value) &#123;</span><br><span class="line">        Object.keys(Object.prototype).forEach(function(Val)&#123;</span><br><span class="line">            if(!Object.hasOwnProperty(Val))&#123;</span><br><span class="line">                delete Object.prototype[Val];</span><br><span class="line">                console.log(&#96;$&#123;Val&#125; is delete&#96;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        if (!isObj(object) || typeof path !&#x3D;&#x3D; &#39;string&#39;) &#123;</span><br><span class="line">            return object;</span><br><span class="line">        &#125;</span><br><span class="line">        const root &#x3D; object;</span><br><span class="line">        const pathArray &#x3D; this.getPathSegments(path);</span><br><span class="line">        for (let i &#x3D; 0; i &lt; pathArray.length; i++) &#123;</span><br><span class="line">            const p &#x3D; pathArray[i];</span><br><span class="line">            if (!isObj(object[p])) &#123;</span><br><span class="line">                object[p] &#x3D; &#123;&#125;;</span><br><span class="line">            &#125;</span><br><span class="line">            if (i &#x3D;&#x3D;&#x3D; pathArray.length - 1) &#123;</span><br><span class="line">                object[p] &#x3D; value;</span><br><span class="line">            &#125;</span><br><span class="line">            object &#x3D; object[p];</span><br><span class="line">        &#125;</span><br><span class="line">        return root;</span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br><span class="line">module.exports &#x3D; manage </span><br></pre></td></tr></table></figure>
            </div>
        
        <footer class="article-footer">
        </footer>
    </div>
</article>






    
        <article id="post-WP-CTFHub-Web" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
                    <div class="article-meta">
                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/100-Web-security/">100 Web security</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/categories/100-Web-security/120-CTF/">120 CTF</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/categories/100-Web-security/120-CTF/121-Web/">121 Web</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link-link" href="/tags/CTF/" rel="tag">CTF</a>, <a class="tag-link-link" href="/tags/WriteUp/" rel="tag">WriteUp</a>
    </div>

                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/wiki/WP-CTFHub-Web/">
            <time datetime="2022-02-08T10:30:06.000Z" itemprop="datePublished">2022-02-08</time>
        </a>
    </div>


                        
                            <i class="fa fa-bar-chart"></i>
                            <span id="busuanzi_container_site_pv"><span id="busuanzi_value_page_pv"></span></span>    
                        
                        
                            <div class="article-meta-button">
                                <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/Tsunamori/Wiki-site/raw/writing/source/_posts/WP-CTFHub-Web.md"> Source </a>
                            </div>
                            <div class="article-meta-button">
                                <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/Tsunamori/Wiki-site/edit/writing/source/_posts/WP-CTFHub-Web.md"> Edit </a>
                            </div>
                            <div class="article-meta-button">
                                <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/Tsunamori/Wiki-site/commits/writing/source/_posts/WP-CTFHub-Web.md"> History </a>
                            </div>
                        
                    </div>
                
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/wiki/WP-CTFHub-Web/">CTFHub web</a>
        </h1>
    

            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
        
            
        
        
            <h2 id="2020"><a href="#2020" class="headerlink" title="2020"></a>2020</h2><h3 id="第五空间-决赛-hard-node-node-js原型链污染"><a href="#第五空间-决赛-hard-node-node-js原型链污染" class="headerlink" title="第五空间-决赛 hard_node (node.js原型链污染)"></a>第五空间-决赛 hard_node (node.js原型链污染)</h3><p>这个题看了原型链污染没什么灵感（因为没找到可以推的源码），最终在某个blog上找到了源码和WP （<a target="_blank" rel="external nofollow noopener noreferrer" href="https://blog.mmf.moe/post/node-fork-proto-env-rce/">https://blog.mmf.moe/post/node-fork-proto-env-rce/</a> ），但似乎不能照着拿flag，不知道是不是后续被做了改动，但这个知识点算是学会了。<br>另外，httpie可以使用<code>-v</code>参数来查看具体发送出去的请求内容。</p>
<h3 id="RCTF-swoole-反序列化"><a href="#RCTF-swoole-反序列化" class="headerlink" title="RCTF-swoole (反序列化)"></a>RCTF-swoole (反序列化)</h3><p>CTFHub的靶场时间很短，所以还是拿到源码先线下分析。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;usr&#x2F;bin&#x2F;env php</span><br><span class="line">&lt;?php</span><br><span class="line">Swoole\Runtime::enableCoroutine($flags &#x3D; SWOOLE_HOOK_ALL);</span><br><span class="line">$http &#x3D; new Swoole\Http\Server(&quot;0.0.0.0&quot;, 80);</span><br><span class="line">$http-&gt;on(&quot;request&quot;,</span><br><span class="line">    function (Swoole\Http\Request $request, Swoole\Http\Response $response) &#123;</span><br><span class="line">        Swoole\Runtime::enableCoroutine();</span><br><span class="line">        $response-&gt;header(&#39;Content-Type&#39;, &#39;text&#x2F;plain&#39;);</span><br><span class="line">        &#x2F;&#x2F; $response-&gt;sendfile(&#39;&#x2F;flag&#39;);</span><br><span class="line">        if (isset($request-&gt;get[&#39;phpinfo&#39;])) &#123;</span><br><span class="line">            &#x2F;&#x2F; Prevent racing condition</span><br><span class="line">            &#x2F;&#x2F; ob_start();phpinfo();</span><br><span class="line">            &#x2F;&#x2F; return $response-&gt;end(ob_get_clean());</span><br><span class="line">            return $response-&gt;sendfile(&#39;phpinfo.txt&#39;);</span><br><span class="line">        &#125;</span><br><span class="line">        if (isset($request-&gt;get[&#39;code&#39;])) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                $code &#x3D; $request-&gt;get[&#39;code&#39;];</span><br><span class="line">                if (!preg_match(&#39;&#x2F;\x00&#x2F;&#39;, $code)) &#123;</span><br><span class="line">                    $a &#x3D; unserialize($code);</span><br><span class="line">                    $a();</span><br><span class="line">                    $a &#x3D; null;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; catch (\Throwable $e) &#123;</span><br><span class="line">                var_dump($code);</span><br><span class="line">                var_dump($e-&gt;getMessage());</span><br><span class="line">                &#x2F;&#x2F; do nothing</span><br><span class="line">            &#125;</span><br><span class="line">            return $response-&gt;end(&#39;Done&#39;);</span><br><span class="line">        &#125;</span><br><span class="line">        $response-&gt;sendfile(__FILE__);</span><br><span class="line">    &#125;</span><br><span class="line">);</span><br><span class="line">$http-&gt;start();</span><br></pre></td></tr></table></figure>

            </div>
        
        <footer class="article-footer">
        </footer>
    </div>
</article>






    
        <article id="post-偷学的渗透小tips" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
                    <div class="article-meta">
                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/100-Web-security/">100 Web security</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/categories/100-Web-security/110-Bug-bounty/">110 Bug bounty</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/categories/100-Web-security/110-Bug-bounty/111-Ideas-WP/">111 Ideas/WP</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link-link" href="/tags/Summary/" rel="tag">Summary</a>
    </div>

                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/wiki/%E5%81%B7%E5%AD%A6%E7%9A%84%E6%B8%97%E9%80%8F%E5%B0%8Ftips/">
            <time datetime="2021-12-05T19:40:18.000Z" itemprop="datePublished">2021-12-06</time>
        </a>
    </div>


                        
                            <i class="fa fa-bar-chart"></i>
                            <span id="busuanzi_container_site_pv"><span id="busuanzi_value_page_pv"></span></span>    
                        
                        
                            <div class="article-meta-button">
                                <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/Tsunamori/Wiki-site/raw/writing/source/_posts/偷学的渗透小tips.md"> Source </a>
                            </div>
                            <div class="article-meta-button">
                                <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/Tsunamori/Wiki-site/edit/writing/source/_posts/偷学的渗透小tips.md"> Edit </a>
                            </div>
                            <div class="article-meta-button">
                                <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/Tsunamori/Wiki-site/commits/writing/source/_posts/偷学的渗透小tips.md"> History </a>
                            </div>
                        
                    </div>
                
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/wiki/%E5%81%B7%E5%AD%A6%E7%9A%84%E6%B8%97%E9%80%8F%E5%B0%8Ftips/">偶然学到的渗透小tips</a>
        </h1>
    

            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
        
            
        
        
            <p>(人菜就要多学习)</p>
<h1 id="简单套路"><a href="#简单套路" class="headerlink" title="简单套路"></a>简单套路</h1><ol>
<li>当请求为<code>数据更新操作（添加、删除、修改等）</code>，且请求包没添加（或可绕过）Referer来源地址、随机CSRF-token时，考虑CSRF/XSRF攻击（burp自动生成payload）</li>
<li>上传位置可以尝试上传html，验证有无html解析（毕竟万年碰不到一个能传马的点了！），危害为钓鱼、挂马、挂黑页等。 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">    &lt;body&gt;</span><br><span class="line">          &lt;script&gt;alert(1)&lt;&#x2F;script&gt;</span><br><span class="line">    &lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure></li>
<li>测越权，burp插件携带权限cookie批量请求值得拥有（实现该功能的插件很多，比如Autorize）。</li>
<li>JS经常泄漏各种API接口（找链接： <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/Threezh1/JSFinder">https://github.com/Threezh1/JSFinder</a> ，也有非链接需要自己构造包含函数名称及参数的数据包的JS，被动搜索浏览器插件： <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/momosecurity/FindSomething">https://github.com/momosecurity/FindSomething</a> ）。</li>
<li>链接里带有URL的点可以试试改成任意URL测重定向（大概算是依靠链接前半部分造成链接可信任，结合短链接等伪装手法，重定向钓鱼）。</li>
</ol>
<h1 id="骚操作"><a href="#骚操作" class="headerlink" title="骚操作"></a>骚操作</h1><h2 id="APP"><a href="#APP" class="headerlink" title="APP"></a>APP</h2><ol>
<li><em><strong>逆向分析YYDS！</strong></em></li>
<li>APP脱壳找证书，放进抓包工具反编译流量（适用于流量内容不可见的情况，具体教程找找看）。</li>
<li><code>adb logcat &gt;&gt; x.txt</code>输出本地日志，可能包含本机用户使用APP时输入的敏感信息。</li>
<li>快速并发数据包，可以实现批量发送短信、刷赞等。（burp-turbo）</li>
<li>将拦截的<code>响应包</code>内容从fail改为success可以实现验证码绕过等（是原理清楚但从来没改过响应包的我），证明校验为前端校验。</li>
<li>Activity劫持（涉及安卓端命令调用了，目测是比较冷门可挖的）。</li>
<li>LaunchAnyWhere （<a target="_blank" rel="external nofollow noopener noreferrer" href="https://chan-shaw.github.io/2020/04/12/LaunchAnyWhere%E7%BB%95%E8%BF%87%E5%8E%9F%E7%90%86/%EF%BC%89">https://chan-shaw.github.io/2020/04/12/LaunchAnyWhere%E7%BB%95%E8%BF%87%E5%8E%9F%E7%90%86/）</a></li>
<li>(这是一条防御办法)当APP做证书绑定后，可以在被抓包时不发送业务请求（但据说有办法仍然实现抓包）。<ol>
<li>确认有效的绕过办法1：VirtualXposed + JustTrustMe，已验证可绕过防抓包加固，使用VirtualXposed是否可以绕过防root加固，目前没有样本，暂时未知。</li>
</ol>
</li>
<li>以下是奇怪的root后替换人脸数据的工具：<ol>
<li>Magisk <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/topjohnwu/Magisk">https://github.com/topjohnwu/Magisk</a></li>
<li>Riru <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/RikkaApps/Riru">https://github.com/RikkaApps/Riru</a></li>
<li>LSPosed <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/LSPosed/LSPosed">https://github.com/LSPosed/LSPosed</a></li>
<li>virtualcam <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/w2016561536/android_virtual_cam">https://github.com/w2016561536/android_virtual_cam</a></li>
</ol>
</li>
</ol>
<h2 id="小程序"><a href="#小程序" class="headerlink" title="小程序"></a>小程序</h2><ol>
<li>发送请求参数被加密时，可解包找公钥。（这怕是不太能防？还是说果然RSA/RSA2不靠谱？）</li>
<li>绕过批量发送限制：在参数末尾每次多加一个对整体无作用的<code>+</code>（猜测只有当参数在请求末端可行？）。</li>
<li>测批量时，不仅可以考虑本网站用户的手机号被批量的问题，也可以加上非注册用户手机号实现批量轰炸的情况（扩大漏洞影响）。</li>
</ol>
<h2 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h2><ol>
<li>api接口无法直接访问时（如swagger），把脚本配置文件（如dirsearch）的host改成网站IP。</li>
<li>注意邮件、短信等携带的链接、短链接内容，可能存在参数可枚举的问题。</li>
<li>必应、雅虎、搜狗、谷歌、etc，没准就有一个可以搜到奇怪的带权限链接。</li>
<li>地址接口 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;fonts&#x2F;</span><br><span class="line">&#x2F;pdf&#x2F;</span><br><span class="line">&#x2F;js&#x2F;</span><br><span class="line">&#x2F;css&#x2F;</span><br><span class="line">&#x2F;img&#x2F;</span><br></pre></td></tr></table></figure></li>
<li>浏览器开插件模拟手机端。</li>
<li>在线客服处总容易出现奇怪的越权/敏感信息泄漏。</li>
<li>抓包改发送的邮件内容搞钓鱼（有意思的思路）。</li>
<li>HTTP请求走私（看来还是该多打CTF）</li>
<li>ip/a/b 会强制跳转到登录口，但ip/a/c不会，则使用ip/a/c/../b绕过跳转。访问xx.jsp会强制转到访问aa.jsp，访问aa.jsp/../../(../多个)/xx.jsp实现绕过过滤。</li>
<li>查询参数留空，可能会出现一次性相应所有查询内容的问题。（遇到过几次，和同事讨论过，大概是因为留空自动从where里排除了，导致全量查询。算是平时比较难去想到和测试的点。）</li>
<li>LDAP 未授权访问 （相比于危害来说，利用未免太过轻松。。。）</li>
<li>HOST碰撞（利用难度低，危害高，技术较新）</li>
<li>API接口服务漏洞，关键词wsdl</li>
<li>分块传输 bypass waf/ waf缓冲区溢出</li>
<li>dirsearch与burp的简单联动，利用burp的proxy发送请求。但经过与dirsearch作者的讨论，目前dirsearch并不能支持与burp很紧密的联动（指从burp实时获取扫描目录等），有见过导出burp目录给dirsearch做扫描的插件，但与我理想中的实时扫描二级/多级目录下敏感目录的功能不太相符。 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 dirsearch.py -u http:&#x2F;&#x2F;whateveraa.test -w $HOME&#x2F;Desktop&#x2F;pentest&#x2F;SecLists&#x2F;Discovery&#x2F;Web-Content&#x2F;merged-no-duplicates.txt -e php -x 301,400,403 --proxy http:&#x2F;&#x2F;127.0.0.1:8080</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="IOT"><a href="#IOT" class="headerlink" title="IOT"></a>IOT</h2><ol>
<li>MQTT协议越权/未授权</li>
</ol>
<h1 id="记录一下看到过的burp插件"><a href="#记录一下看到过的burp插件" class="headerlink" title="记录一下看到过的burp插件"></a>记录一下看到过的burp插件</h1><ol>
<li>JSON Decoder 解码JSON（新burp不是可以直接美化json？）</li>
<li>MarkINFO (<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/UUUUnotfound/BurpSuite-Extender-MarkInfo">https://github.com/UUUUnotfound/BurpSuite-Extender-MarkInfo</a>) 高亮敏感信息</li>
<li>highlighter-and-extractor</li>
<li>APIKit (<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/API-Security/APIKit">https://github.com/API-Security/APIKit</a>)</li>
<li>BurpCrypto</li>
<li>BurpDomain (<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/404SEC/BurpDomain">https://github.com/404SEC/BurpDomain</a>)</li>
<li>turbo</li>
<li>Logger++</li>
<li>Bypass WAF</li>
<li>JSON Web Tokens</li>
<li>lazyCSRF <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/tkmru/lazyCSRF/releases/">https://github.com/tkmru/lazyCSRF/releases/</a></li>
<li>ActiveScan++</li>
<li>LinkFinder</li>
</ol>
<h1 id="记录一下其他脚本工具"><a href="#记录一下其他脚本工具" class="headerlink" title="记录一下其他脚本工具"></a>记录一下其他脚本工具</h1><ol>
<li>reverse-sourcemap 还原jsmap （可以用curl命令对付不能直接下载的js.map文件）</li>
<li>wxappUnpacker</li>
<li>微信小程序加解密脚本：<a target="_blank" rel="external nofollow noopener noreferrer" href="http://82.156.16.24/index.php/2021/05/26/4.html">http://82.156.16.24/index.php/2021/05/26/4.html</a></li>
<li>HOST碰撞 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/fofapro/Hosts_scan">https://github.com/fofapro/Hosts_scan</a></li>
<li>fiddler（虽然不是脚本工具但是有看到某个大佬用这个抓包，可能有特别之处）</li>
</ol>

            </div>
        
        <footer class="article-footer">
        </footer>
    </div>
</article>






    
        <article id="post-Note-JAVA代码审计-入门篇" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
                    <div class="article-meta">
                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/100-Cyber-security/">100 Cyber security</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/categories/100-Cyber-security/140-Code-review-%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">140 Code review 代码审计</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/categories/100-Cyber-security/140-Code-review-%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/149-Notes/">149 Notes</a>
    </div>

                        
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/wiki/Note-JAVA%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1-%E5%85%A5%E9%97%A8%E7%AF%87/">
            <time datetime="2021-09-22T01:47:07.000Z" itemprop="datePublished">2021-09-22</time>
        </a>
    </div>


                        
                            <i class="fa fa-bar-chart"></i>
                            <span id="busuanzi_container_site_pv"><span id="busuanzi_value_page_pv"></span></span>    
                        
                        
                            <div class="article-meta-button">
                                <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/Tsunamori/Wiki-site/raw/writing/source/_posts/Note-JAVA代码审计-入门篇.md"> Source </a>
                            </div>
                            <div class="article-meta-button">
                                <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/Tsunamori/Wiki-site/edit/writing/source/_posts/Note-JAVA代码审计-入门篇.md"> Edit </a>
                            </div>
                            <div class="article-meta-button">
                                <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/Tsunamori/Wiki-site/commits/writing/source/_posts/Note-JAVA代码审计-入门篇.md"> History </a>
                            </div>
                        
                    </div>
                
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/wiki/Note-JAVA%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1-%E5%85%A5%E9%97%A8%E7%AF%87/">note_JAVA代码审计-入门篇</a>
        </h1>
    

            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
        
            
        
        
            <h2 id="第1章-初识JAVA代码审计"><a href="#第1章-初识JAVA代码审计" class="headerlink" title="第1章 初识JAVA代码审计"></a>第1章 初识JAVA代码审计</h2><h2 id="第2章-代码审计环境搭建"><a href="#第2章-代码审计环境搭建" class="headerlink" title="第2章 代码审计环境搭建"></a>第2章 代码审计环境搭建</h2><ol>
<li>使用环境：JAVA JDK、Docker、Vulhub、IntelliJ IDEA(远程调试)、VMware、Maven</li>
</ol>
<h2 id="第3章-代码审计辅助工具简介"><a href="#第3章-代码审计辅助工具简介" class="headerlink" title="第3章 代码审计辅助工具简介"></a>第3章 代码审计辅助工具简介</h2><ol>
<li>代码编辑器：Sublime、IDEA、Eclipse</li>
<li>测试工具：Burp Suite、SwitchyOmega、Max HackerBar、Postman、Postwoman、Tamper Data、Ysoserial、Marshalsec、MySQL监视工具、Beyond Compare</li>
<li>反编译工具：JD-GUI、FernFLower、CFR、IntelliJ IDEA</li>
<li>JAVA代码静态扫描工具：Fortify、VCG、FindBugs与FindSecBugs插件、SpotBugs</li>
<li>公开漏洞查找平台：CVE、NVD、CNVD、CNNVD</li>
</ol>
<h2 id="Java-EE基础知识"><a href="#Java-EE基础知识" class="headerlink" title="Java EE基础知识"></a>Java EE基础知识</h2><h3 id="Java-EE"><a href="#Java-EE" class="headerlink" title="Java EE"></a>Java EE</h3><h4 id="Java-EE常用核心技术"><a href="#Java-EE常用核心技术" class="headerlink" title="Java EE常用核心技术"></a>Java EE常用核心技术</h4><ol>
<li>Java 数据库连接 （JDBC）：用于规范客户端程序如何访问数据库的应用程序接口。</li>
<li>Java 命名和目录接口（JNDI）：Java的一个目录服务应用程序界面（API），将服务名称和对象关联起来，从而使开发可以用名称来访问对象。</li>
<li>企业级JavaBean（EJB）：用来构筑企业级应用的、在服务端可被管理的组件。</li>
<li>远程方法调用（RMI）：是Java的一组用户开发分布式应用程序的API，增强Java开发分布式应用的能力。</li>
<li>Servlet：是使用Java编写的服务端程序，狭义的Servlet指Java语言实现的一个接口，广义上指任何实现该Servlet接口的类。主要功能在于交互式地浏览和修改数据，生成动态内容。</li>
<li>JSP（JavaServer Pages）：一种动态网页技术标准，部署在网络服务器上，可以相应用户端发送的请求，并根据请求内容动态生成HTML、XML或其他格式文档的Web网页，返回给请求者。</li>
<li>可扩展标记语言（XML）：是被设计用于传输和存储数据的语言。</li>
<li>Java消息服务（Java Message Service, JMS）是一个Java平台中关于面向消息中间件（MOM）的API，用于在两个应用程序之间或分布式系统中发生消息，进行异步通信。</li>
</ol>
<h4 id="Java-EE-分层模型"><a href="#Java-EE-分层模型" class="headerlink" title="Java EE 分层模型"></a>Java EE 分层模型</h4><ol>
<li>Domain Object(领域对象)层：由一系列POJO（Plain Old Java Object）组成，这些对象是该系统的Domain Object，通常包含各自所需实现的业务逻辑方法。</li>
<li>DAO(Data Access Object, 数据访问对象)层：由一系列DAO组件组成，实现对数据库创建、查询、更新、删除等操作。</li>
<li>Service(业务逻辑)层：由一系列控制器组成，用于拦截用户请求，并调用业务逻辑组件的业务逻辑方法处理用户请求，根据处理结果向不同View组件转发。</li>
<li>View(表现)层：由一系列页面及视图组件组成，负责收集用户请求，并显示处理后的结果。</li>
</ol>
<h3 id="MVC"><a href="#MVC" class="headerlink" title="MVC"></a>MVC</h3><p>MVC，即为Model View Controller，三个核心部件，独自处理各自的任务。这种分离思想应用在代码审计中，以抓住关键问题。</p>
<h4 id="Java-MVC"><a href="#Java-MVC" class="headerlink" title="Java MVC"></a>Java MVC</h4><ol>
<li>Model：表示携带数据的对象或Java POJO，即使模型内的数据改变，它也具有逻辑来更新控制器。</li>
<li>Controller：表示逻辑控制，它对模型和视图都有作用，控制数据流进入模型对象，并在数据更改时更新视图，是视图和模型的中间层。</li>
<li>View：表示模型包含的数据的可视化层。<br>工作流程：控制层接收用户请求，决定调用哪个模型，模型处理用户请求并返回数据，最后由视图层将数据转化呈现给用户。MVC模式使视图层和业务层分离，比如修改View层代码时，不用重新编译Model和Controller代码。</li>
</ol>
<h4 id="Java-MVC框架"><a href="#Java-MVC框架" class="headerlink" title="Java MVC框架"></a>Java MVC框架</h4><ol>
<li>Struts1</li>
<li>Struts2</li>
<li>Spring MVC</li>
<li>JSF</li>
<li>Tapestry</li>
</ol>
<h3 id="Servlet"><a href="#Servlet" class="headerlink" title="Servlet"></a>Servlet</h3>
            </div>
        
        <footer class="article-footer">
        </footer>
    </div>
</article>






    
        <article id="post-Notes_代码审计-企业级web代码安全结构" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
                    <div class="article-meta">
                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/100-Web-security/">100 Web security</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/categories/100-Web-security/140-Code-review-%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">140 Code review/代码审计</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link-link" href="/tags/Notes/" rel="tag">Notes</a>
    </div>

                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/wiki/Notes_%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1-%E4%BC%81%E4%B8%9A%E7%BA%A7web%E4%BB%A3%E7%A0%81%E5%AE%89%E5%85%A8%E7%BB%93%E6%9E%84/">
            <time datetime="2021-07-17T10:05:28.000Z" itemprop="datePublished">2021-07-17</time>
        </a>
    </div>


                        
                            <i class="fa fa-bar-chart"></i>
                            <span id="busuanzi_container_site_pv"><span id="busuanzi_value_page_pv"></span></span>    
                        
                        
                            <div class="article-meta-button">
                                <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/Tsunamori/Wiki-site/raw/writing/source/_posts/Notes_代码审计-企业级web代码安全结构.md"> Source </a>
                            </div>
                            <div class="article-meta-button">
                                <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/Tsunamori/Wiki-site/edit/writing/source/_posts/Notes_代码审计-企业级web代码安全结构.md"> Edit </a>
                            </div>
                            <div class="article-meta-button">
                                <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/Tsunamori/Wiki-site/commits/writing/source/_posts/Notes_代码审计-企业级web代码安全结构.md"> History </a>
                            </div>
                        
                    </div>
                
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/wiki/Notes_%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1-%E4%BC%81%E4%B8%9A%E7%BA%A7web%E4%BB%A3%E7%A0%81%E5%AE%89%E5%85%A8%E7%BB%93%E6%9E%84/">代码审计 企业级web代码安全结构</a>
        </h1>
    

            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
        
            
        
        
            <p>苦于代码审计能力偏弱，调研一番发现这本书或许有所帮助。</p>
<h2 id="第一部分-代码审计前的准备"><a href="#第一部分-代码审计前的准备" class="headerlink" title="第一部分 代码审计前的准备"></a>第一部分 代码审计前的准备</h2><h3 id="代码审计环境搭建"><a href="#代码审计环境搭建" class="headerlink" title="代码审计环境搭建"></a>代码审计环境搭建</h3><ol>
<li>wamp/wnmp: WAMP（Windows下的Apache+Mysql/MariaDB+Perl/PHP/Python），WNMP（Windows下的Nginx+Mysql+PHP）</li>
<li>lamp/lnmp：将上述环境安装在Linux中。</li>
</ol>
<h4 id="PHP-INI-常量的定义"><a href="#PHP-INI-常量的定义" class="headerlink" title="PHP_INI_*常量的定义"></a>PHP_INI_*常量的定义</h4><ol>
<li>PHP_INI_USER：该配置选项可在用户的PHP脚本或Win注册表中设置。</li>
<li>PHP_INI_PERDIR：该配置选项可在php.ini. .htaccess或httpd.conf中设置。</li>
<li>PHP_INI_SYSTEM：该配置选项可在任何地方设置。</li>
<li>PHP_INI_ALL：该配置选项可在任何地方设置。</li>
<li>php.ini only：该配置选项可仅可在php.ini中配置。</li>
</ol>
<h4 id="会影响PHP脚本安全的配置列表及核心配置选项"><a href="#会影响PHP脚本安全的配置列表及核心配置选项" class="headerlink" title="会影响PHP脚本安全的配置列表及核心配置选项"></a>会影响PHP脚本安全的配置列表及核心配置选项</h4><ol>
<li>register_globals(全局变量注册开关)：该选项在on的情况下，会将用户GET/POST等方式提交上来的参数注册成全局变量并初始化值为参数对应的值，使提交参数可以直接在脚本中使用。register_globals在PHP版本小于等于4.2.3时设置为PHP_INI_ALL，从PHP5.3.0起被废弃，在PHP5.4.0中被移除。<br> 代码实例：(实验环境php5.2.17,在php.ini中添加register_globals = On) <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">if($user&#x3D;&#x3D;&#39;admin&#39;)&#123;</span><br><span class="line">  echo &#39;true&#39;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>allow_url_include(是否允许包含远程文件)：在该配置为on的情况下，可以直接包含远程文件，当存在include(<code>$var</code>)且$var可控的情况下，可以直接控制$var变量来执行PHP代码。allow_url_include在PHP5.2.0后默认设置为off，配置范围为PHP_INI_ALL。与之类似的配置有allow_url_fopen，配置是否允许打开远程文件，但安全隐患没有前者大。<br> 代码实例：(实验环境php5.2.17，payload：a=<a target="_blank" rel="external nofollow noopener noreferrer" href="http://127.0.0.1/test/info.txt">http://127.0.0.1:80/test/info.txt</a> ，info.txt内容为<code>&lt;?php phpinfo();?&gt;</code>) <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">include $_GET[&#39;a&#39;];</span><br></pre></td></tr></table></figure></li>
<li>magic_quotes_gpc（魔术引号自动过滤）：该参数在不存在编码或其他特殊绕过的情况下，可以使很多漏洞无法利用。当该参数被开启时（选项设置为on），会自动在GET、POST、COOKIE变量中的单引号（‘）、双引号（“）、反斜杠（\）及空字符（NULL）的前面加上反斜杠（\），但在PHP5中magic_quotes_gps并不会过滤$_SERVER变量，导致很多类似client-ip、referer一类的漏洞能够利用。PHP5.3之后不推荐使用该参数，PHP5.4之后被取消。在PHP版本小于4.2.3时，配置范围是PHP_INI_ALL;在PHP版本大于4.2.3时，是PHP_INI_PERDIR。<br> 代码实例：(测试?a=1’) <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">echo $_GET[&#39;a&#39;];</span><br></pre></td></tr></table></figure></li>
<li>magic_quotes_runtime(魔术引号自动过滤)：过滤方式同样为加反斜杠，但和magic_quotes_gpc的处理对象不一样。magic_quotes_runtime只对从数据库或文件中获取的数据进行过滤，magic_quotes_runtime在PHP5.4之后被取消，配置范围是PHP_INI_ALL。但该参数仅对部分函数有作用，某些情况下可以被绕过。<br> 代码实例： <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#1.txt</span><br><span class="line">1&#39;2&quot;3\4</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">ini_set(&quot;magic_quotes_runtime&quot;,&quot;1&quot;);</span><br><span class="line">echo file_get_contents(&quot;1.txt&quot;);</span><br></pre></td></tr></table></figure></li>
<li>magic_quotes_sybase(魔术引号自动过滤)：用于自动过滤特殊字符，当设置为on时，会覆盖magic_quotes_gpc=on的配置（使gpc=on失效）。与gpc的共同点是处理对象一致（GET、POST、Cookie)，但该参数仅转义空字符以及把单引号变成双引号，使用率比gpc低。配置范围为PHP_INI_ALL，在PHP5.4.0中移除。（代码实例与gpc相同）</li>
<li>safe_mode（安全模式）：是PHP内嵌的一种安全机制，配置范围为PHP_INI_SYSTEM，PHP5.4之后被取消（取消原因是，PHP开发者认为在PHP语言机制上试图解决安全问题是一件不合适的事情，虽然safe_mode在一定程度上对共享主机有效，但同时也带来了不少误报，与其在PHP上解决权限安全问题，不如使用linux默认的权限限制机制或其它层级的解决办法）。该参数效果为，所有文件操作函数都会受到限制，非文件所有者不能对该文件进行操作（如include()），如果有一些脚本文件放在非Web服务启动用户所有的目录下，需要利用include等函数进行加载，可以使用safe_mode_include_dir来配置可包含的路径。此外，通过函数popen()、system()以及exec()等函数执行命令或程序会提示错误，如果需要使用外部脚本，可以集中存放，然后用safe_node_exec_dir来指向存放目录。<br> 代码实例： <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># echo &#96;whoami&#96;; 执行命令失败的回显提示</span><br><span class="line">Warning: shell_exec() [function, shell_exec]: Cannot execute using backquotes in Safe Mode ...</span><br></pre></td></tr></table></figure></li>
<li>open_basedir（PHP可访问目录）：用于限制PHP只能访问哪些目录，通常只需要设置Web文件目录即可，如果需要加载外部脚本，也需要把所在路径加入该指令中，多个目录以分号分割。需要注意，指定限制实际上是前缀而不是目录名，如配置open_basedir=/www/a，那么/www/a和/www/ab都可以访问，所以为了避免该现象发生，需要用斜线结束路径名，如/www/a/。当参数激活，执行脚本访问其它文件时都需要验证文件路径，所以会影响执行效率。该指令配置范围在PHP&lt;5.2.3时是PHP_INI_SYSTEM，在PHP&gt;=5.2.3时是PHP_INI_ALL。</li>
<li>disable_functions(禁用函数)：使用该指令来禁止敏感函数的使用，使用本指令时，需把dl()函数也添加进禁用列表，否则攻击者可以利用dl()函数价值自定义的PHP扩展突破该指令的限制。指令范围为php.ini，配置禁用函数时使用逗号分割函数名。</li>
<li>display_errors和error_reporting错误显示：display_errors用于表明是否显示PHP脚本内部错误，生产环境中建议关闭，在开启时，可以通过设置error_reporting来设置错误显示的级别。配置范围均为PHP_INI_ALL。</li>
</ol>
<h3 id="审计辅助与漏洞验证工具"><a href="#审计辅助与漏洞验证工具" class="headerlink" title="审计辅助与漏洞验证工具"></a>审计辅助与漏洞验证工具</h3><h4 id="代码编辑器"><a href="#代码编辑器" class="headerlink" title="代码编辑器"></a>代码编辑器</h4><ol>
<li>Notepad++</li>
<li>UltraEdit（文件对比）</li>
<li>Zend Studio（PHP集成开发环境）</li>
</ol>
<h4 id="代码审计工具"><a href="#代码审计工具" class="headerlink" title="代码审计工具"></a>代码审计工具</h4><ol>
<li>Seay源代码审计系统</li>
<li>RIPS</li>
</ol>
<h4 id="漏洞验证辅助"><a href="#漏洞验证辅助" class="headerlink" title="漏洞验证辅助"></a>漏洞验证辅助</h4><ol>
<li>Burp</li>
<li>浏览器扩展：Hackbar, Firebug, Live HTTP Headers, Modify</li>
<li>编码转换及加解密工具：Seay代码审计系统自带的编码功能，Burp自带的decoder，超级加解密转换工具</li>
<li>正则调试工具：Seay自带的正则调试功能，灵者正则调试</li>
<li>SQL执行监控工具：Seay mysql监控</li>
</ol>
<h2 id="漏洞发现与防范"><a href="#漏洞发现与防范" class="headerlink" title="漏洞发现与防范"></a>漏洞发现与防范</h2><h3 id="通用代码审计思路"><a href="#通用代码审计思路" class="headerlink" title="通用代码审计思路"></a>通用代码审计思路</h3><h4 id="敏感函数回溯参数过程"><a href="#敏感函数回溯参数过程" class="headerlink" title="敏感函数回溯参数过程"></a>敏感函数回溯参数过程</h4><p>根据敏感函数来逆向追踪参数的传递过程，使用较多，因为大多数漏洞都是由于函数使用不当造成的。非函数使用不当的漏洞，如SQL注入，也有一些特征，如Select、Incert等，结合From和Where等关键字判断是否为一条SQL语句，通过对字符串的识别分析，就能判断该SQL语句参数有没有使用单引号过滤，或者根据经验判断。如HTTP头里面的HTTP_CLIENT_IP和HTTP_X_FORWORDFOR等获取到的IP地址常直接拼接到SQL语句中，且由于它们是存在于<code>$_SERVER</code>变量中不受GPC的影响，那么就可以查找这两个参数关键字快速寻找漏洞。<br>该方法的优点是定向挖掘、高效、高质量，缺点是对整体框架了解不够深入，定位利用点会花费时间，另外无法覆盖逻辑漏洞。</p>
<h4 id="通读全文代码"><a href="#通读全文代码" class="headerlink" title="通读全文代码"></a>通读全文代码</h4><p>在企业中做自身产品代码审计时，我们需要了解整个应用的业务逻辑以获取更多漏洞。<br>通读全文代码时，首先要看程序的大体代码结构，如主目录有哪些文件，模块目录有哪些文件，插件目录有哪些文件，还要注意文件大小、创建时间。根据文件命名可大致了解该程序实现哪些功能，核心文件是哪些。<br>在看程序目录结构时，要特别注意以下几个文件：</p>
<ol>
<li><code>函数集文件</code>，通常命名中包含functions或者common等关键字，这些文件内是一些公共函数，提供给其它文件统一调用，所以大多数文件会在文件头包含其它文件。寻找这些文件的一个技巧就是打开index.php或一些功能性文件，在头部一般都能找到。</li>
<li><code>配置文件</code>，通常命名中包含config关键字，包括Web程序运行必须的功能性配置选项及数据库等配置信息，从该文件中可以了解程序的小部分功能，另外看这个文件时注意观察配置文件中参数值是用单引号还是双引号，如果是双引号，则很可能存在代码执行漏洞。（如利用PHP可变变量（$$a）的特性执行代码，ref：<a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.cnblogs.com/Cl0ud/p/12336834.html%EF%BC%89">https://www.cnblogs.com/Cl0ud/p/12336834.html）</a></li>
<li><code>安全过滤文件</code>，该文件关系到挖掘到的可疑点能否利用，通常命名中有filter、safe、check等关键字。这类文件主要作用是针对参数进行过滤，比较常见的是针对SQL注入和XSS过滤，还有文件路径、执行的系统命令的参数，其它相对少见。而目前大多数应用会在程序入口循环对所有参数使用addslashes()进行过滤。</li>
<li><code>index文件</code>，是一个程序的入口文件，通过阅读该文件可大致了解整个程序的架构、运行流程、包含的文件，以及核心文件有哪些。而不同的目录的index文件也有不同的实现方式，最好先将核心目录的index文件都简单读一遍。<br>学习代码审计前期建议先下载一些小应用来读，积累经验后，再去读开源框架。</li>
</ol>
<h4 id="根据功能点定向审计"><a href="#根据功能点定向审计" class="headerlink" title="根据功能点定向审计"></a>根据功能点定向审计</h4><p>先简单黑盒测试一下，再通过发现的容易出问题的功能去阅读该功能点的源码，提高审计速度。</p>
<ol>
<li>文件上传功能：任意上传、SQL注入</li>
<li>文件管理功能：任意文件操作、XSS漏洞</li>
<li>登录认证功能：任意用户登录</li>
<li>找回密码功能：验证码爆破、验证凭证算法</li>
</ol>
<h3 id="漏洞挖掘与防范（基础篇）"><a href="#漏洞挖掘与防范（基础篇）" class="headerlink" title="漏洞挖掘与防范（基础篇）"></a>漏洞挖掘与防范（基础篇）</h3><h4 id="SQL注入"><a href="#SQL注入" class="headerlink" title="SQL注入"></a>SQL注入</h4><h5 id="挖掘经验"><a href="#挖掘经验" class="headerlink" title="挖掘经验"></a>挖掘经验</h5><p>常出现在登录页面、获取HTTP头（user-agent/client-ip等）、订单处理等业务相对复杂的地方，登录页面注入大多出现在HTTP头的client-ip和x-forward-for，用于记录登录IP地址。另外在订单系统内，由于订单涉及购物车等多个交互，经常会发生二次注入，通读代码时可着重关注这几个地方。</p>
<ol>
<li>普通注入：指最容易利用的SQL注入漏洞，有int型和string型，在string型注入中需要使用单或双引号闭合。数据库操作存在一些关键字，如select from、mysql_connect、mysql_query、mysql_fetch_row等，查询方式还有update、incert、delete，只需要在白盒审计中查找这些关键字即可定向挖掘SQL注入。</li>
<li>编码注入：程序在进行一些操作前经常会进行编码处理，而做编码处理的函数可能会存在问题。通过输入转码函数不兼容的特殊字符，即可导致输出字符变成有害数据，在SQL注入里，最常见的编码注入是MySQL宽字节以及urldecode/rawurldecode函数导致的。<ul>
<li>宽字节注入：使用PHP连接MySQL的时候，当设置<code>set character_set_client=gbk</code>时会导致一个编码转换的注入问题，当存在该漏洞时，注入参数里带入<code>%df%27</code>，即可把程序中过滤的<code>\(%5c)</code>吃掉。而通常都不是直接设置<code>set character_set_client=gbk</code>，而是设置<code>SET NAMES ‘gbk’</code>，同样存在漏洞。官方建议是使用mysql_set_charset来设置编码，只要在后面合理的使用mysql_real_escape_string还是可以解决该漏洞的。对宽字节注入的挖掘方法比较简单，搜索<code>SET NAMES</code>、<code>character_set_client=gbk</code>、<code>mysql_set_charset(&#39;gbk&#39;)</code>。该漏洞的解决方法如以下三种，比较推荐一和三：<ul>
<li>在执行查询前先执行<code>SET NAMES &#39;gbk&#39;, character_set_client=binary</code></li>
<li>使用mysql_set_charset(‘gbk’)设置编码，然后使用mysql_real_escape_string()过滤。</li>
<li>使用pdo方式，在PHP5.3.6及以下版本中需要设置<code>setAttribute(PDO::ATTR_EMULATE_PREPARES,false);</code>，来禁用prepared statements的仿真效果。</li>
</ul>
</li>
<li>二次urlencode注入：只要字符被进行转换就有可能产生漏洞。现在的Web程序大多会进行参数过滤，通常使用addslashes()、mysql_real_escape_string()、mysql_escape_string()函数或者开启GPC的方式来防止注入，也就是给单引号、双引号、反斜杠（\）和NULL加上反斜杠转义。如果某处使用了urldecode或者rawurldecode函数，则会导致二次加码生成单引号而引发注入。该漏洞可以通过搜索urldecode和rawurldecode函数来挖掘。</li>
</ul>
</li>
</ol>
<h5 id="漏洞防范"><a href="#漏洞防范" class="headerlink" title="漏洞防范"></a>漏洞防范</h5><ol>
<li>gpc/runtime魔术引号：通常数据污染有两种方式，一种是应用被动接收参数，另一种是主动获取参数。利用magic_quotes_gpc和magic_quotes_runtime可以防止部分SQL注入（对int型注入没有太大作用）</li>
<li>过滤函数和类：有两种使用场景，一种是程序入口统一过滤，框架程序使用这种方式比较多，另一种是在程序进行SQL语句运行前使用，除了PHP内置的一些过滤单引号等函数外，还有一些开源类过滤union、select等关键字。<ul>
<li>addslashes函数：过滤单引号、双引号、反斜杠以及空字符NULL，大多被用在程序入口，判断如果没有开启GPC则使用该函数进行过滤。不过它的参数必须是string类，所以可能会存在通过数组绕过的漏洞。</li>
<li>mysql_[real_]escape_string函数：这两个函数都是对字符串进行过滤，只存在于大于PHP4.03的版本，[<code>\x00</code>]、[<code>\n</code>]、[<code>\r</code>]、[<code>\</code>]、[<code>&#39;</code>]、[<code>&quot;</code>]、[<code>\xla</code>]会受到影响。两个函数唯一不一样的地方在于mysql_real_escape_string接受的是一个连接句柄并根据当前字符集转移字符串，推荐使用。</li>
<li>intval等字符转换：上述方式在int类型注入时效果不会，比如可以通过报错或盲注等方式来绕过，这时候就要用到intval函数了。intval的作用是将变量转换成int类型，这里举例intval是要表达一种利用参数类型白名单的方式来防止漏洞，对应的还有很多如floatval等。</li>
</ul>
</li>
<li>PDO prepare预编译：通过预编译的方式来处理数据库查询。当PHP版本&lt;5.3.6时，使用PHP本地模拟prepare再把完整的SQL语句发送给MySQL服务器，且使用set names ‘gbk’时，仍然存在宽字节SQL注入，因为PHP和MySQL编码不一致。正确的写法应该是使用ATTR_EMULATE_PREPARES来禁用PHP本地模拟prepare。</li>
</ol>
<h4 id="XSS漏洞"><a href="#XSS漏洞" class="headerlink" title="XSS漏洞"></a>XSS漏洞</h4><h5 id="挖掘经验-1"><a href="#挖掘经验-1" class="headerlink" title="挖掘经验"></a>挖掘经验</h5><p>挖掘XSS漏洞关键在于寻找没有被过滤的参数，且这些参数传入至输出函数。常用输出函数列表如下：<code>print、print_r、echo、printf、sprintf、die、var_dump、var_export</code>，寻找带有变量的这些函数即可。另外在代码审计中，浏览器环境对XSS漏洞利用影响非常大。通读代码时可多关注各处设置资料、文章发表、留言等富文本区域，这种地方存在的XSS通常是存储型的。</p>
<h5 id="反射型-XSS"><a href="#反射型-XSS" class="headerlink" title="反射型 XSS"></a>反射型 XSS</h5><p>直接通过外部输入在浏览器端输出触发，该种漏洞比较容易通过扫描器黑盒审计发现。白盒审计中，只需要寻找带有参数的输出参数，根据输出参数对输出内容回溯输入参数，观察有没有经过过滤。</p>
<h5 id="存储型XSS"><a href="#存储型XSS" class="headerlink" title="存储型XSS"></a>存储型XSS</h5><p>把利用代码保存在数据库或文件中，当Web程序读取利用代码并输出在页面上时执行利用代码。比反射型容易利用，较为隐蔽且不用考虑绕过浏览器过滤。挖掘时也是需要寻找未过滤的输入点和未过滤的输出函数（可能完全不在同一个业务流中），可以根据当前代码功能去猜，或追寻数据有在哪里被操作，使用表名、字段名去代码里搜索。</p>
<h5 id="漏洞防范-1"><a href="#漏洞防范-1" class="headerlink" title="漏洞防范"></a>漏洞防范</h5><ol>
<li>特殊字符HTML实体转码。</li>
<li>标签事件属性黑白名单。</li>
</ol>
<h4 id="CSRF漏洞"><a href="#CSRF漏洞" class="headerlink" title="CSRF漏洞"></a>CSRF漏洞</h4><h5 id="挖掘经验-2"><a href="#挖掘经验-2" class="headerlink" title="挖掘经验"></a>挖掘经验</h5><p>主要用于越权操作，所以漏洞会出现在有权限控制的地方。黑盒挖洞可以先搭建环境，打开几个有非静态操作的页面，抓包看看有没有token，没有token就不带referer直接请求该页面，返回数据一样的话，可能存在CSRF漏洞。白盒审计，通读代码时看看被大量引用的基础文件（核心文件）、你比较关心的功能点代码内有没有验证token和referer相关的代码，或者直接搜索token关键字。</p>
<h5 id="漏洞防范-2"><a href="#漏洞防范-2" class="headerlink" title="漏洞防范"></a>漏洞防范</h5><ol>
<li>增加token/referer验证避免img标签请求的水坑攻击。</li>
<li>增加验证码。（比较麻烦，更适用于敏感操作页面）</li>
</ol>
<h3 id="漏洞挖掘与防范（进阶篇）"><a href="#漏洞挖掘与防范（进阶篇）" class="headerlink" title="漏洞挖掘与防范（进阶篇）"></a>漏洞挖掘与防范（进阶篇）</h3><h4 id="文件操作漏洞"><a href="#文件操作漏洞" class="headerlink" title="文件操作漏洞"></a>文件操作漏洞</h4><h5 id="文件包含漏洞"><a href="#文件包含漏洞" class="headerlink" title="文件包含漏洞"></a>文件包含漏洞</h5><p>文件包涵函数有include()、include_once()（前两个在包含文件时即使遇到错误，下面的代码仍然执行）、require()、require_once()（这两个在包含文件时遇到错误会报错退出程序）。</p>
<h6 id="挖掘经验-3"><a href="#挖掘经验-3" class="headerlink" title="挖掘经验"></a>挖掘经验</h6><p>文件包含漏洞大多出现在模块加载、模板加载以及cache调用的地方。在挖掘漏洞时可以跟踪程序运行流程，看模块加载包含的文件是否可控等，另一个是直接搜索上文四个函数来回溯寻找可控变量。一般该类漏洞都是本地文件包含，大多需要截断。</p>
<h6 id="本地文件包含"><a href="#本地文件包含" class="headerlink" title="本地文件包含"></a>本地文件包含</h6><p>本地文件包含（local file include，LFI），大多出现在模块加载、模板加载和cache调用，有多种利用方式，如上传一个允许上传的文件格式的文件再包含以执行代码，包含PHP上传的临时文件，在请求URL或ua里面加入要执行的代码，WebServer记录到日志后再包含WebServer的日志，还有像Linux下可以包含/proc/self/environ文件。</p>
<h6 id="远程文件包含"><a href="#远程文件包含" class="headerlink" title="远程文件包含"></a>远程文件包含</h6><p>远程文件包含（remote file include, RFI），需要设置allow_url_include = On，相比于本地包含来说更容易利用，但出现频率不高。</p>
<h6 id="文件包含截断"><a href="#文件包含截断" class="headerlink" title="文件包含截断"></a>文件包含截断</h6><ol>
<li>使用<code>%00</code>截断，最古老的方法，受限于GPC和addslashes等函数的过滤，另外PHP5.3之后的版本已经全面修复，不能使用该方法了。</li>
<li>使用多个英文句号<code>.</code>和反斜杠<code>/</code>来阶段，不受GPC限制，但同样在PHP5.3之后被修复。</li>
<li>远程文件包含时利用问号<code>？</code>来伪截断，不受GPC和PHP版本限制，只要能返回代码给包含函数就能执行。在HTTP协议里，访问<a target="_blank" rel="external nofollow noopener noreferrer" href="http://remotehost/i.txt%E5%92%8C%E8%AE%BF%E9%97%AEhttp://remotehost/i.txt?.php">http://remotehost/i.txt和访问http://remotehost/i.txt?.php</a> 返回的结果是一样的，因为WebServer把问号之后的内容当成请求参数，而txt不在WebServer里解析，参数对访问i.txt返回的内容不影响，实现伪截断。</li>
</ol>
<h5 id="文件读取（下载）漏洞"><a href="#文件读取（下载）漏洞" class="headerlink" title="文件读取（下载）漏洞"></a>文件读取（下载）漏洞</h5><h6 id="挖掘经验-4"><a href="#挖掘经验-4" class="headerlink" title="挖掘经验"></a>挖掘经验</h6><p>文件读取漏洞比较容易寻找，一种方式是可以先黑盒看功能点对应的文件，再去读文件源码。另一种是搜索文件读取的函数（<code>file_get_contents()、highlight_file()、fopen()、readfile()、fread()、fgetss()、fgets()、parse_ini_file()、show_source()、file()</code>），看有无可直接或间接控制的变量，除了正常读取文件的函数之外，另外一些其他功能的函数也可以用于读取文件，如include()等。</p>
<h5 id="文件上传漏洞"><a href="#文件上传漏洞" class="headerlink" title="文件上传漏洞"></a>文件上传漏洞</h5><h6 id="挖掘经验-5"><a href="#挖掘经验-5" class="headerlink" title="挖掘经验"></a>挖掘经验</h6><p>挖掘简单，上传点常调用同一个上传类，上传函数又只有move_uploaded_file()这一个，所以最快方法就是直接搜索该函数，再去看调用的代码存不存在未限制上传格式或者可以绕过，其中问题较多的是黑名单限制文件格式以及未更改文件名的方式，在未改名的情况下，在Apache利用其向前寻找解析格式和IIS6的分号解析bug都可以执行代码。</p>
<ol>
<li>未过滤或本地过滤：共同点是都未在服务器端过滤。</li>
<li>黑名单扩展名过滤：出现较少，存在限制的扩展名不够全、验证扩展名的方式存在问题可直接绕过或截断。</li>
<li>文件头、content-type验证绕过：早期出现较多，上传文件时，如果直接上传一个非图片文件会被提示不是图片文件，但只要在文件头里加上<code>GIF89a</code>后上传，则验证通过。这是因为程序用了如getimagesize()函数等。content-type是在http request请求头内，所以可以被攻击者修改，而早期的一些程序只是单纯的验证了这个值。</li>
</ol>
<h5 id="文件删除漏洞"><a href="#文件删除漏洞" class="headerlink" title="文件删除漏洞"></a>文件删除漏洞</h5><p>常出现在有文件管理功能的应用上，原理和文件读取差不多，只不过利用的函数不一样，一般因为删除的文件名可以用<code>../</code>跳转，或者没有限制当前用户权限。</p>
<h6 id="挖掘经验-6"><a href="#挖掘经验-6" class="headerlink" title="挖掘经验"></a>挖掘经验</h6><p>。挖掘漏洞可以先去找相应的功能点，黑盒测试一下能不能删除某个文件，如果删除不了，再去从执行流程追踪提交的文件名参数的传递过程。如果纯白盒挖，也可以去搜索带有变量参数的unlink()，采取回溯变量的方式。</p>
<h5 id="文件操作漏洞防范"><a href="#文件操作漏洞防范" class="headerlink" title="文件操作漏洞防范"></a>文件操作漏洞防范</h5><h6 id="通用文件操作防御"><a href="#通用文件操作防御" class="headerlink" title="通用文件操作防御"></a>通用文件操作防御</h6><ol>
<li>合理的权限管理。</li>
<li>以加密等方式替代直接将文件名作为下载参数的操作。</li>
<li>避免目录跳转，禁止参数中携带<code>..</code>、<code>/</code>、<code>\</code>来跳转目录。</li>
</ol>
<h6 id="文件上传漏洞防范"><a href="#文件上传漏洞防范" class="headerlink" title="文件上传漏洞防范"></a>文件上传漏洞防范</h6><ol>
<li>白名单过滤文件扩展名，使用in_array或<code>===</code>来对比扩展名。</li>
<li>保存上传文件时重命名文件，文件名采用时间戳的拼接随机数的MD5值保存方式<code>md5(time()+rand(1,10000))</code></li>
</ol>
<h4 id="代码执行漏洞"><a href="#代码执行漏洞" class="headerlink" title="代码执行漏洞"></a>代码执行漏洞</h4><h5 id="挖掘经验-7"><a href="#挖掘经验-7" class="headerlink" title="挖掘经验"></a>挖掘经验</h5><p>eval()和assert()函数导致的代码执行漏洞大多是因为载入缓存或者模板以及对变量的处理不严格导致。<br>preg_replace()函数代码执行需要存在/e参数，这个函数原本是用来处理字符串的，因此漏洞出现最多的是在对字符串的处理，比如URL、HTML标签以及文章内容等过滤功能。<br>call_user_func()和call_user_func_array()函数的功能是调用函数，多用在框架里面动态调用函数，所以一般比较小的程序不常出现该类代码执行。array_map()函数的作用是调用函数并且除第一个参数外其它参数为数组，通常会写死第一个参数，即调用的参数，类似这三个函数功能的函数还有很多。<br>还有一类非常常见的是动态函数的代码执行，如<code>$_GET($_POST[&quot;xx&quot;])</code>。</p>
<h5 id="代码执行函数"><a href="#代码执行函数" class="headerlink" title="代码执行函数"></a>代码执行函数</h5><ol>
<li>eval和assert函数：用于动态执行函数，所以它们的参数就是PHP代码。</li>
<li>preg_replace函数：对字符串进行正则处理。</li>
<li>调用函数过滤不严：数十个函数有调用其它函数的功能，如果传入的函数名可控，那么就可以调用意外的函数来执行需要的代码，即存在代码执行漏洞。这些函数有：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">call_user_func()、call_user_func_array()、array_map()、</span><br><span class="line">usort()、uasort()、uksort()、array_filter()、</span><br><span class="line">array_reduce()、array_diff_uassoc()、array_diff_ukey()、</span><br><span class="line">array_udiff()、array_udiff_assoc()、array_udiff_uassoc()、</span><br><span class="line">array_intersect_assoc()、array_intersect_uassoc、</span><br><span class="line">array_uintersect()、array_uintersect_assoc()、</span><br><span class="line">array_uintersect_uassoc()、array_walk()、array_walk_recursive()、</span><br><span class="line">xml_set_character_data_handler()、xml_set_default_handler()、</span><br><span class="line">xml_set_element_handler()、xml_set_end_namespace_decl_handler()、</span><br><span class="line">xml_set_external_entity_ref_handler()、xml_set_notation_decl_handler()、</span><br><span class="line">xml_set_processing_instruction_handler()、</span><br><span class="line">xml_set_start_namespace_decl_handler()、</span><br><span class="line">xml_set_unparsed_entity_decl_handler()、stream_filter_register()、</span><br><span class="line">set_error_handler()、register_shutdown_function()、register_tick_function()</span><br></pre></td></tr></table></figure></li>
</ol>
<h5 id="动态函数执行"><a href="#动态函数执行" class="headerlink" title="动态函数执行"></a>动态函数执行</h5><p>由于PHP的特性，PHP函数可以直接由字符串拼接，加大了安全控制的难度。PHP动态函数写法为<code>变量（参数）</code>，例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$_GET[&#39;a&#39;]($_GET[&#39;b&#39;]);# poc:?a&#x3D;assert&amp;b&#x3D;phpinfo()</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>想要挖掘这种形式的代码执行漏洞，需要找可控的动态函数名。</p>
<h5 id="漏洞防范-3"><a href="#漏洞防范-3" class="headerlink" title="漏洞防范"></a>漏洞防范</h5><p>采用参数白名单过滤，这里的白名单并不是说完全固定为参数，可以结合正则表达式来进行白名单限制。</p>
<h4 id="命令执行漏洞"><a href="#命令执行漏洞" class="headerlink" title="命令执行漏洞"></a>命令执行漏洞</h4><p>代码执行漏洞指的是可以执行PHP脚本代码，而命令执行漏洞指的是可以执行系统或应用指令（如CMD命令或bash命令）的漏洞。PHP的命令执行漏洞主要基于一些函数的参数过滤不严导致，可以执行命令的函数有system()、exec()、shell_exec()、passthru()、pcntl_exec()、popen()、proc_open()这七个函数，另外反引号也可以执行命令，不过实际上这种方式也是调用的shell_exec()函数。PHP命令执行继承了WebServer用户权限，一般该权限都可以向Web目录写文件。</p>
<h5 id="挖掘经验-8"><a href="#挖掘经验-8" class="headerlink" title="挖掘经验"></a>挖掘经验</h5><p>该漏洞多出现在包含环境包的应用里，一般这类产品会有额外的脚本来协助处理日志及数据库等，web应用会有比较多的点之间使用system()、exec()、shell_exec()、passthru()、pcntl_exec()、popen()、proc_open()等函数执行系统命令来调用这些脚本，可以直接在代码中搜索这几个函数，收获应该会不少。除了这类应用，还有一些调用外部程序的功能也会出命令执行漏洞，由于特征明显，可以直接搜索函数名进行挖掘。</p>
<h6 id="命令执行函数"><a href="#命令执行函数" class="headerlink" title="命令执行函数"></a>命令执行函数</h6><p>上述的函数中，sustem()、exec()、shell_exec()、passthru()以及反引号是可以直接传入命令并返回执行结果。<br>popen()、proc_open()函数不会直接返回执行结果，而是返回一个文件指针。</p>
<h6 id="反引号命令执行"><a href="#反引号命令执行" class="headerlink" title="反引号命令执行"></a>反引号命令执行</h6><p>反引号执行命令是调用的shell_exec()函数。</p>
<h5 id="漏洞防范-4"><a href="#漏洞防范-4" class="headerlink" title="漏洞防范"></a>漏洞防范</h5><ol>
<li>使用PHP自带的命令防注入函数，包括escapeshellcmd()（过滤整条命令）和escapeshellarg()（保证传入命令执行函数的参数确实是以字符串参数形式存在，不能被注入）。</li>
<li>对命令执行函数的参数做白名单限制。（通用修复方法）</li>
</ol>
<h3 id="漏洞挖掘与防范（深入篇）"><a href="#漏洞挖掘与防范（深入篇）" class="headerlink" title="漏洞挖掘与防范（深入篇）"></a>漏洞挖掘与防范（深入篇）</h3><h4 id="变量覆盖漏洞"><a href="#变量覆盖漏洞" class="headerlink" title="变量覆盖漏洞"></a>变量覆盖漏洞</h4><p>变量覆盖指的是可以用我们自定义的参数值替换程序原有的变量值，通常需要结合程序的其它功能来实现完整攻击。<br>该类漏洞大多由函数使用不当导致，常引发漏洞的函数有：extract()函数和parse_str()，import_request_variables()函数则是用于未开启全局变量注册时，调用该函数相当于开启了全局变量注册，在PHP5.4后该函数已经被取消。另外部分应用利用$$的方式注册变量没验证已有变量导致覆盖，这些应用在使用外部传递进来的参数时不是用类似于<code>$_GET[&#39;key&#39;]</code>这样原始的数组变量，而是把里面的key注册成一个变量$key，注册过程中没有验证该变量是否已经存在，所以会导致变量覆盖。</p>
<h5 id="挖掘经验-9"><a href="#挖掘经验-9" class="headerlink" title="挖掘经验"></a>挖掘经验</h5><p>由于变量覆盖漏洞通常要结合其他功能代码来实现完整攻击，所以挖掘可用的变量覆盖漏洞还要考虑究竟哪些变量可以被覆盖并且后面有被使用。<br>由函数导致的变量覆盖比较好挖掘，寻找参数带有变量的extract()、parse_str()函数，回溯变量是否可控。import_request_variables()则只需要找没有初始化且操作前没有赋值的变量，就可以大胆的提交该变量作为参数，另外只要写在该函数前的变量，不管是否已经初始化都可以覆盖，不过该函数只在PHP4-4.1.0以及5-5.4.0可用。<br>关于国内很多程序使用<code>$$</code>符号注册变量会导致变量覆盖，可以直接搜索<code>$$</code>去挖掘，不过建议挖掘前应通读核心文件。</p>
<h6 id="函数使用不当"><a href="#函数使用不当" class="headerlink" title="函数使用不当"></a>函数使用不当</h6><ol>
<li>extract()（最常见）：将数组中的键值对注册成变量，函数结构如下： <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int extract (array &amp;$var_array [, int $extract_type &#x3D; EXTR_OVERWRITE [, string $prefix &#x3D; NULL]])</span><br></pre></td></tr></table></figure>
 该函数有3种可能会覆盖已有变量，第一种是第二个参数为EXTR_OVERWRITE，它表示如果有冲突，则覆盖已有变量；第二种是只传入第一个参数，默认为EXTR_OVERWRITE模式；第三种则是第二个参数为EXTR_IF_EXISTS，表示仅在当前符号表中已有同名变量时，覆盖它们的值，其它的都不注册新变量。</li>
<li>parse_str()：解析字符串并注册成变量，在注册变量前不会验证当前变量是否已经存在，所以会直接覆盖掉已有变量。该函数有两个参数： <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">void parse_str(string $str [, array &amp;$arr])</span><br></pre></td></tr></table></figure>
 其中<code>$str</code>是必须的，代表要解析注册成变量的字符串，形式为<code>a=1</code>，经过函数后会注册变量$a并赋值1。第二个参数$arr是一个数组，当第二个参数存在时，注册的变量会放在这个数组内，但如果该数组内原先就存在相同的键（key），则会覆盖原有键值。</li>
<li>import_request_variables()：作用是把GET、POST、COOKIE的参数注册成变量，用在register_globals被禁止的时候，需要PHP4.1-5.4之间的版本。不过建议不开globals的时候也不要使用该函数，容易造成变量覆盖。</li>
</ol>
<h6 id="变量覆盖"><a href="#变量覆盖" class="headerlink" title="$$变量覆盖"></a>$$变量覆盖</h6><p>由于双$导致原变量被覆盖，在漏洞代码之前的变量都可以被覆盖。</p>
<h5 id="漏洞防范-5"><a href="#漏洞防范-5" class="headerlink" title="漏洞防范"></a>漏洞防范</h5><p>最常见漏洞点是做变量注册以及赋值给变量的时候没有验证变量是否存在，所以推荐使用原始的变量数组，如<code>$_GET</code>、<code>$_POST</code>，或者在注册变量前一定要验证变量是否存在。</p>
<h6 id="使用原始变量"><a href="#使用原始变量" class="headerlink" title="使用原始变量"></a>使用原始变量</h6><p>由于上述变量覆盖漏洞是在进行变量注册时导致，所以要解决变量覆盖的问题，最直接的方法就是不进行变量注册，直接使用原生的<code>$_GET</code>、<code>$_POST</code>等数组变量进行操作，如果考虑到程序可读性等原因，需要注册个别变量，可以直接在代码中定义变量，然后再把请求中的值赋值给它。</p>
<h6 id="验证变量存在"><a href="#验证变量存在" class="headerlink" title="验证变量存在"></a>验证变量存在</h6><p>如果一定要用前面几种方式注册变量，可以在注册变量前先判断变量是否存在，如使用extract()函数则可以配置第二个参数为EXTR_SKIP。使用parse_str()函数注册变量钱需要自行通过代码判断变量是否存在。不建议使用import_request_variables()注册全局变量，会导致变量不可控。最重要的，自行申明的变量一定要初始化，不然即便注册在执行代码前也能被覆盖。</p>
<h4 id="逻辑处理漏洞"><a href="#逻辑处理漏洞" class="headerlink" title="逻辑处理漏洞"></a>逻辑处理漏洞</h4><p>此次指程序在业务逻辑上的漏洞。</p>
<h5 id="挖掘经验-10"><a href="#挖掘经验-10" class="headerlink" title="挖掘经验"></a>挖掘经验</h5><p>漏洞大多存在于逻辑处理及业务流程中，没有特别明显的关键字用于快速定位，挖掘技巧通常是通读功能点源码，熟悉业务流程，可关注程序是否可重复安装、修改密码处是否可越权修改其它用户密码、找回密码验证码是否可暴力破解以及修改其它用户密码、cookie是否可预测或cookie验证是否可绕过等。</p>
<h6 id="等于与存在判断绕过"><a href="#等于与存在判断绕过" class="headerlink" title="等于与存在判断绕过"></a>等于与存在判断绕过</h6><p>判断函数存在漏洞时，可以逃逸判断函数绕过逻辑。常见存在漏洞的判断函数有：</p>
<ol>
<li>in_array()：用于判断一个值是否在某个数组列表里，该函数存在一个问题，比较前会自动做类型转换，实现输入参数并不全等于数组任意值时，也可以实现绕过并注入。</li>
<li>is_numeric()：用于判断一个变量是否为数字，检查通过返回true，否则返回false。该函数存在一个问题，当传入参数为hex时则直接通过并返回true，而mysql是可以直接使用hex编码代替字符串名为的。所以这里虽然不能直接注入SQL语句，但存在二次注入和XSS等漏洞隐患，比如当我们提交<code>&lt;script&gt;alert(1)&lt;/script&gt;</code>的hex编码时，效果相同。如果程序有其它地方调用该值并直接输出，则有可能执行代码触发XSS漏洞。</li>
<li>双等于和三等于：双等于在判断等于前会先做变量类型转换，三等于则不会，所以双等于存在安全风险。</li>
</ol>
<h6 id="账户体系中的越权漏洞"><a href="#账户体系中的越权漏洞" class="headerlink" title="账户体系中的越权漏洞"></a>账户体系中的越权漏洞</h6><p>漏洞分为水平越权和垂直越权，但漏洞原理相同，都是账户体系在判断权限时不严格导致存在绕过漏洞。这一类绕过通常发生在cookie验证不严、简单判断用户提交的参数，归根结底，都是因为参数在客户端提交，服务端未严格校验。</p>
<h6 id="未exit或return引发的安全问题"><a href="#未exit或return引发的安全问题" class="headerlink" title="未exit或return引发的安全问题"></a>未exit或return引发的安全问题</h6><p>某些情况下，在经过if条件判断之后，要么继续执行if后面的代码，要么在if流程内退出当前操作，但该退出行为，有不少程序忘记写return、die()、或者exit()，导致程序继续执行。</p>
<h6 id="常见支付漏洞"><a href="#常见支付漏洞" class="headerlink" title="常见支付漏洞"></a>常见支付漏洞</h6><p>最常见支付漏洞有四种，第1、2、3种比较简单，分别是客户端可修改单价、总价和购买数量，服务器端未严格校验导致。部分商城程序是直接由单价和数量计算总价，但并没有验证这两个数字是否小于0。这种形式的支付漏洞，可以通过寻找支付代码并看代码过滤情况挖掘。<br>还有一种是以重复发包来利用时间差，少量钱多次购买，如使用手机给腾讯发送购买QQ业务的短信再快速取消。这类漏洞可从判断余额及扣费功能代码处寻找。</p>
<h5 id="漏洞防范-6"><a href="#漏洞防范-6" class="headerlink" title="漏洞防范"></a>漏洞防范</h5><ol>
<li>深入熟悉业务逻辑。</li>
<li>多熟悉函数的功能和差异。</li>
</ol>
<h4 id="会话认证漏洞"><a href="#会话认证漏洞" class="headerlink" title="会话认证漏洞"></a>会话认证漏洞</h4><h5 id="挖掘经验-11"><a href="#挖掘经验-11" class="headerlink" title="挖掘经验"></a>挖掘经验</h5><p>在cookie验证上出现几率较高，通常是没有使用session认证，而是将用户信息直接保存在cookie中，以备程序使用时直接调用。一般这个过程都会有一个统一的函数去调用数据，容易导致SQL注入和越权等漏洞。在挖掘登录认证漏洞时，可以先看程序的登录功能代码，看整个登录过程的业务逻辑有没有可以控制session值或直接绕过密码验证的漏洞；另外需要关注程序验证是否为登录的代码，通俗的说是验证cookie的代码，是不是直接取cookie的值，然后如何判断这个值来验证是否登录。</p>
<h6 id="cookie认证安全"><a href="#cookie认证安全" class="headerlink" title="cookie认证安全"></a>cookie认证安全</h6><p>cookie可以保存任何字符串，各个浏览器保存cookie字节数大小不一样，一般不超过4096个字节，通常用于保存登录帐号的标识信息。cookie出现问题较多的是cookie的SQL注入等常见漏洞，以及web应用程序在服务端直接读取cookie值来操作当前用户数据，由于cookie可以伪造，从而导致伪造用户身份登录的漏洞。</p>
<h5 id="漏洞防范-7"><a href="#漏洞防范-7" class="headerlink" title="漏洞防范"></a>漏洞防范</h5><p>了解认证的业务逻辑，严格限制输入的异常字符以及避免直接使用客户端提交的内容进行操作。应该结合cookie和session，不能直接从cookie获取参数值进行操作，另外注意设置session时，需要保证客户端不能操作敏感session参数。特别注意敏感数据不要放在cookie中，cookie在浏览器端以及传输过程中都有被窃取的可能性。</p>
<h3 id="二次漏洞审计"><a href="#二次漏洞审计" class="headerlink" title="二次漏洞审计"></a>二次漏洞审计</h3><h4 id="什么是二次漏洞"><a href="#什么是二次漏洞" class="headerlink" title="什么是二次漏洞"></a>什么是二次漏洞</h4><p>需要先构造好利用代码写入网站保存，在第二次或多次请求后调用攻击代码触发或修改配置触发的漏洞叫做二次漏洞。该漏洞的出现归根结底是开发者在可信数据的逻辑上考虑不全面。</p>
<h4 id="二次漏洞审计技巧"><a href="#二次漏洞审计技巧" class="headerlink" title="二次漏洞审计技巧"></a>二次漏洞审计技巧</h4><p>虽然二次漏洞写入和触发payload很可能不在同一个地方，但还是可以通过找相关关键字去定位的，只是精准度会稍微降低。大多数二次漏洞的逻辑性比一般的漏洞强的多，所以最好还是把全部代码读一遍，更好的了解业务逻辑和全局配置。<br>业务逻辑越复杂的地方越容易出现二次漏洞，我们可以重点关注购物车、订单、引用数据、文章编辑、草稿等和数据库交互的地方，以及和文件系统交互的系统配置文件（一般需要管理员权限才能操作）。<br>在二次漏洞类型里，可以重点关注SQL注入、XSS。</p>
<h3 id="代码审计小技巧"><a href="#代码审计小技巧" class="headerlink" title="代码审计小技巧"></a>代码审计小技巧</h3><h4 id="钻GPC等转义的空子"><a href="#钻GPC等转义的空子" class="headerlink" title="钻GPC等转义的空子"></a>钻GPC等转义的空子</h4><p>GPC会自动把提交内容的敏感字符转义导致攻击代码无法执行，但还是存在漏洞：</p>
<h5 id="SERVER变量"><a href="#SERVER变量" class="headerlink" title="$_SERVER变量"></a>$_SERVER变量</h5><p>在PHP5后，用<code>$_SERVER</code>取到的<code>header</code>字段不受GPC影响，且普通程序员很少会考虑到这些字段。<code>header</code>注入里常见的是<code>user-agent</code>、<code>referer</code>以及<code>client-ip/x-forward-for</code>，因为大多数Web应用都会记录访问者的IP以及<code>referer</code>等信息，同样的<code>$_FILES</code>变量也不受GPC保护。</p>
<h5 id="编码转换问题"><a href="#编码转换问题" class="headerlink" title="编码转换问题"></a>编码转换问题</h5><p>宽字节注入就是一种非常典型的编码转换问题导致绕过GPC的方式。不仅是PHP与MySQL交互过程中会发生编码转换导致问题，PHP自带的编码转换函数也会发生问题，比如mb_convert_encoding()、iconv()，也就是只要发生编码转换就有可能会出现问题。</p>
<h4 id="神奇的字符串"><a href="#神奇的字符串" class="headerlink" title="神奇的字符串"></a>神奇的字符串</h4><h5 id="字符处理函数报错信息泄漏"><a href="#字符处理函数报错信息泄漏" class="headerlink" title="字符处理函数报错信息泄漏"></a>字符处理函数报错信息泄漏</h5><p>页面的报错信息通常能泄漏文件绝对路径、代码、变量及函数等信息，页面报错有很多情况，但不是所有情况页面都会出现错误信息，显示错误信息需要在PHP配置文件中打开并设置等级。<br>大多数错误提示会显示文件路径，可以获取Web路径。由于用户提交数据在后端大多是以字符串方式处理，所以利用字符串处理函数报错成了必不可少的方法，对于利用参数来报错的方式，给函数传入不同类型的变量是最实用的方式。</p>
<h5 id="字符串截断"><a href="#字符串截断" class="headerlink" title="字符串截断"></a>字符串截断</h5><p>截断利用最多的是在文件操作上面，通常用来利用文件包含漏洞和文件上传漏洞，<code>%00</code>即NULL会被GPC和addslashes()过滤掉，所以利用<code>%00</code>截断需要GPC关闭以及不被addslashes()函数过滤，另外PHP5.3之后也不能用这种方式截断。</p>
<ol>
<li>iconv字符编码转换截断：如从UTF-8转换到GBK，部分代码不能被成功转换（chr(128)-chr(255)之间），在利用该函数转码时，遇到不能处理的字符串时后续字符串不会被处理。</li>
</ol>
<h4 id="php-输入输出流"><a href="#php-输入输出流" class="headerlink" title="php://输入输出流"></a>php://输入输出流</h4><h4 id="PHP代码解析标签"><a href="#PHP代码解析标签" class="headerlink" title="PHP代码解析标签"></a>PHP代码解析标签</h4><ol>
<li>最标准的<code>&lt;?php?&gt;</code></li>
<li>脚本标签：<code>&lt;script language=&quot;php&quot;&gt;&lt;/script&gt;</code>，可以正常解析PHP代码</li>
<li>短标签：<code>&lt;?...?&gt;</code>，使用短标签需要在php.ini中设置short_open_tag=on，默认为on状态。</li>
<li>asp标签<code>&lt;%...%&gt;</code>，在PHP3.0.4后可用，需要在php.ini中设置asp_tags=on，默认为off。<br>通常用于绕过<code>&lt;?php?&gt;</code>标签过滤以留后门及绕过Web程序或waf写入webshell。</li>
</ol>
<h4 id="fuzz漏洞发现"><a href="#fuzz漏洞发现" class="headerlink" title="fuzz漏洞发现"></a>fuzz漏洞发现</h4><h4 id="不严谨的正则表达式"><a href="#不严谨的正则表达式" class="headerlink" title="不严谨的正则表达式"></a>不严谨的正则表达式</h4><ol>
<li>没有用<code>^</code>和<code>$</code>限定匹配开始位置</li>
<li>特殊字符未转义，匹配特殊字符的原字符时需要使用反斜杠<code>\</code>来进行转义，不然<code>.</code>则可以用来表示任何字符，存在安全隐患。</li>
</ol>
<h4 id="十余种MySQL报错注入"><a href="#十余种MySQL报错注入" class="headerlink" title="十余种MySQL报错注入"></a>十余种MySQL报错注入</h4><p>利用报错注入最快拿到注入的数据。</p>
<ol>
<li>floor():<code>id=1 and (select 1 from (select count(*),concat(user(),floor(rand(0)*2))x from information_schema.tables group by x)a)</code></li>
<li>extractvalue():<code>id=1 and (extractvalue(1, concat(0x5c, (select user()))))</code></li>
<li>updatexml():<code>id=1 AND (updatexml(1,concat(0x5e24,(select user()),0x5e24),1))</code></li>
<li>GeometryCollection():<code>id=1 AND GeometryCollection((select * from(select * from(select user())a)b))</code></li>
<li>polygon():<code>id=1 AND polygon((select * from(select * from(select user())a)b))</code></li>
<li>multipoint():<code>id=1 AND multipoint((select * from(select * from(select user())a)b))</code></li>
<li>multilinestring():<code>id=1 AND multilinestring((select * from(select * from(select user())a)b))</code></li>
<li>multipolygon():<code>id=1 AND multipolygon((select * from(select * from(select user())a)b))</code></li>
<li>linestring():<code>id=1 AND linestring((select * from(select * from(select user())a)b))</code></li>
<li>exp():<code>id=1 and EXP(~(select * from(select user())a))</code></li>
</ol>
<h4 id="Windows-FindFirstFile"><a href="#Windows-FindFirstFile" class="headerlink" title="Windows FindFirstFile"></a>Windows FindFirstFile</h4><p>目前大多数程序会对上传文件名加密，这样我们就无法直接得到上传webshell文件路径，但在windows下时，我们只需要知道文件所在目录，利用win特性就可以访问文件，因为win在搜索文件时使用了FindFirstFile这一个winapi函数去一个文件夹（包括子文件夹）去搜索指定文件。<br>利用方法很简单，只需要将文件名不可知部分之后的字符用<code>&lt;</code>或<code>&gt;</code>代替即可，不过要注意，只使用一个<code>&lt;</code>或<code>&gt;</code>则只能代表一个字符，如果文件名是12345或更长，请求<code>1&lt;</code>或<code>1&gt;</code>都访问不到文件，需要<code>1&lt;&lt;</code>才能访问到，代表继续往下搜索，有点像win的短文件名。<br>目前所有PHP版本都可用，PHP并没有在语言层面禁止使用<code>&lt;&gt;</code>这些特殊字符，从函数层面来讲，可以利用这个特性的函数有：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">include() include_once() require() require_once()</span><br><span class="line">fopen() ziparchive::open()</span><br><span class="line">copy()</span><br><span class="line">file_get_contents() parse_ini_file() readfile()</span><br><span class="line">file_put_contents()</span><br><span class="line">mkdir()</span><br><span class="line">tempnam() touch()</span><br><span class="line">move_uploaded_file()</span><br><span class="line">opendir() readdir() rewinddir() closedir()</span><br></pre></td></tr></table></figure>

<h4 id="PHP可变变量"><a href="#PHP可变变量" class="headerlink" title="PHP可变变量"></a>PHP可变变量</h4><p>部分PHP应用在写配置文件或使用preg_replace()函数第二个参数赋值变量时，会用到双引号来代表string类型给变量赋值，存在代码执行漏洞。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$a&#x3D;&quot;$&#123;@phpinfo()&#125;&quot;;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>注意，上述代码中的<code>@</code>是必须存在的，不然代码无法执行，但除了该符号外还有其它写法，只要不影响PHP规范就可以执行，举例：</p>
<ol>
<li>花括号内第一个字符为空格：<code>$a = &quot;$&#123; phpinfo()&#125;&quot;;</code></li>
<li>花括号内第一个字符为TAB：<code>$a = &quot;$&#123;  phpinfo()&#125;&quot;;</code></li>
<li>花括号内第一个字符为注释符：<code>$a = &quot;$&#123;/**/phpinfo()&#125;&quot;;</code></li>
<li>花括号内第一个字符为回车换行符：<code>$a = &quot;$&#123; phpinfo()&#125;&quot;;</code></li>
<li>花括号内第一个字符为加号：<code>$a = &quot;$&#123;+phpinfo()&#125;&quot;;</code></li>
<li>花括号内第一个字符为减号：<code>$a = &quot;$&#123;-phpinfo()&#125;&quot;;</code></li>
<li>花括号内第一个字符为感叹号：<code>$a = &quot;$&#123;!phpinfo()&#125;&quot;;</code><br>除此之外还有一些如<code>~</code>、<code>\</code>等。</li>
</ol>
<h2 id="PHP安全编程规范"><a href="#PHP安全编程规范" class="headerlink" title="PHP安全编程规范"></a>PHP安全编程规范</h2><h3 id="参数的安全过滤"><a href="#参数的安全过滤" class="headerlink" title="参数的安全过滤"></a>参数的安全过滤</h3><h4 id="第三方过滤函数与类"><a href="#第三方过滤函数与类" class="headerlink" title="第三方过滤函数与类"></a>第三方过滤函数与类</h4><p>目前大多数程序都有一个统一的参数过滤入口，但对于特定场景和漏洞就不够好用。所以除了总入口，在具体功能点也需要进行过滤。</p>
<h4 id="内置过滤函数"><a href="#内置过滤函数" class="headerlink" title="内置过滤函数"></a>内置过滤函数</h4><ol>
<li>SQL注入过滤函数：有addslashes()、mysql_real_escape_string()以及mysql_escape_string()，作用都是给字符串添加反斜杠<code>\</code>来转义掉单引号、双引号、反斜杠以及空字符NULL。addslashes()和mysql_escape_string()都是直接在敏感字符串前加反斜杠，可能会存在宽字节注入绕过的问题，而mysql_real_escape_string()会考虑当前连接数据库的字符集编码，更加安全。</li>
<li>XSS过滤函数：有htmlspecialchars()和strip_tags()，功能不同，htmlspecialchars作用是将字符串中的特殊字符转换成HTML实体编码，能够干掉大多数的XSS攻击。strip_tags则是用来去掉HTML及PHP标记。</li>
<li>命令执行过滤函数：有escapeshellcmd()和escapeshellarg()两个函数，escapeshellcmd过滤的字符为下方代码框所示，win下过滤方式则是在这些字符前面加了<code>^</code>符号，linux下则是在这些字符前加了反斜杠。escapeshellarg函数过滤较简单，给所有参数加上一对双引号，强制为字符串。 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&amp;,;,&#96;,|,*,?,~,&lt;,&gt;,^,(,),[,],&#123;,&#125;,$,\,\x0A,\xFF,% 以及单双引号</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="使用安全的加密算法"><a href="#使用安全的加密算法" class="headerlink" title="使用安全的加密算法"></a>使用安全的加密算法</h3><ol>
<li>对称加密：算法安全性比较高，数据的实际安全性取决于密钥的管理。所以不建议使用对称加密对用户密码进行加密存储。</li>
<li>非对称加密：安全性比对称加密更好。</li>
<li>单向加密：不可逆算法，常见如MD系列和sha1，通常用于保存密码和做数字签名，但存在碰撞的问题。</li>
</ol>
<h3 id="业务功能安全设计"><a href="#业务功能安全设计" class="headerlink" title="业务功能安全设计"></a>业务功能安全设计</h3><h4 id="验证码"><a href="#验证码" class="headerlink" title="验证码"></a>验证码</h4><h5 id="验证码绕过"><a href="#验证码绕过" class="headerlink" title="验证码绕过"></a>验证码绕过</h5><ol>
<li>不刷新直接绕过：后端接收一次请求后并没有主动刷新验证码，将验证码和session绑定在一起，为了保证验证码正常使用，会把验证码明文或加密后放在Cookie或POST数据包里，所以每次只要同一个数据包里的两个验证码对应即可绕过。（重复发包利用？）</li>
<li>暴力破解：验证码能够被爆破，主要是程序没有设置验证码错误次数和超时设定，导致能够不断尝试。</li>
<li>机器识别：利用机器识别验证码。</li>
<li>打码平台：人工打码绕过。</li>
</ol>
<h6 id="对策"><a href="#对策" class="headerlink" title="对策"></a>对策</h6><ol>
<li>设置验证码错误次数（最重要）。</li>
<li>不把验证码放在HTML页面或cookie中。</li>
<li>验证码设置只能请求一次，请求一次后不管错误与否都在后端程序强制刷新。</li>
<li>短信或邮件验证码必须要6位以上字母和数字混合，图片或语音验证码需要加强混淆干扰。（短信验证码这条似乎在当前不适用，多数厂商选择限制短时间同IP发包等，但不增加验证码复杂度）</li>
<li>验证码要动态生成，不能统一生成多次调用。</li>
</ol>
<h5 id="验证码资源滥用"><a href="#验证码资源滥用" class="headerlink" title="验证码资源滥用"></a>验证码资源滥用</h5><p>利用大量网站短信验证码未限制获取验证码次数和时间间隔的接口，实现短信/邮箱轰炸。防护比较简单，限制单个手机号在一个时间段内请求接收短信的次数，或限制某一IP在一个时间段内请求接收短信的次数。</p>
<h4 id="用户登录"><a href="#用户登录" class="headerlink" title="用户登录"></a>用户登录</h4><h5 id="撞库登录"><a href="#撞库登录" class="headerlink" title="撞库登录"></a>撞库登录</h5><p>指登录口没有做登录次数限制，导致可以使用不同的用户及密码不断进行登录尝试，遍历用户密码。撞库漏洞情况有：</p>
<ol>
<li>用户名和密码错误次数都无限制。</li>
<li>单时间段内用户密码错误次数限制。（可以使用单密码和用户名列表撞库）</li>
<li>单时间段内IP登录错误次数限制。（存在误杀内网用户的可能）<br>比较好的解决方案是使用登录验证码和多因素认证。</li>
</ol>
<h5 id="API登录"><a href="#API登录" class="headerlink" title="API登录"></a>API登录</h5><p>免重新登录跳转处存在漏洞，如修改用户参数实现任意登录。对于这种漏洞注意以下安全点：</p>
<ol>
<li>登录密钥（clientkey）需要不可预测且不固定，生成key的算法中加入随机字符。</li>
<li>API接口禁止搜索引擎收录。</li>
<li>登录密钥当次绑定当前主机，换机器不可用，防止木马和嗅探。</li>
</ol>
<h4 id="用户注册"><a href="#用户注册" class="headerlink" title="用户注册"></a>用户注册</h4><ol>
<li>设计验证码。</li>
<li>采集用户机器唯一识别码，拦截短时间内多次注册。</li>
<li>根据帐号格式自学习识别垃圾帐号。</li>
<li>防止SQL注入漏洞与XSS漏洞（常见）。</li>
</ol>
<h4 id="密码找回"><a href="#密码找回" class="headerlink" title="密码找回"></a>密码找回</h4><ol>
<li>输入用户名/邮箱/手机阶段：抓包修改手机/邮箱参数。</li>
<li>填写验证码和新密码阶段：<ul>
<li>验证凭证简单，可以被暴力破解。</li>
<li>验证凭证算法简单，凭证可以被预测。</li>
<li>验证凭证直接保存在源码里。</li>
</ul>
</li>
<li>发送新密码阶段：<br>凭证未绑定用户：请求发送至邮箱的找回密码链接时，后端根据uid和key对应判断该链接有效，但将新密码提交到服务器时，服务器端没有判断当前key是否和uid或邮箱匹配，直接修改掉uid或邮箱指定的用户密码。这样只要拦截修改密码的请求包，篡改用户参数即可。所以安全风险点应该注意的有：<ul>
<li>接收验证码的邮箱和手机号不可由用户控制，应直接从数据库读取。</li>
<li>加强验证凭证复杂度，防止被暴力破解。</li>
<li>限制验证凭证错误次数，单用户在一定时间内验证码错误一定次数，强制等待一段时间。</li>
<li>验证凭证设置失效时间。</li>
<li>验证凭证不要保存在页面。</li>
<li>输入用户邮箱或ID、手机号取验证凭证的地方需要设置验证码防止短信炸弹和批量找回等。</li>
<li>验证凭证跟用户名、用户ID、用户邮箱绑定，找回密码时验证当前凭证是否是当前用户的。</li>
</ul>
</li>
</ol>
<h4 id="资料查看和修改"><a href="#资料查看和修改" class="headerlink" title="资料查看和修改"></a>资料查看和修改</h4><p>这里主要介绍的是越权漏洞的利用。</p>
<ol>
<li>未验证用户权限：直接修改当前资源ID即可访问该资源，没有验证当前资源是否属于当前用户。</li>
<li>未验证当前登录用户：虽然程序绑定了用户ID和资源ID，但该用户ID是访问资源时直接从cookie或post、get参数里获取，所以可以通过修改成另一用户ID，利用其权限操作资源。<br>上述漏洞较多出现在用户资料修改，及用户资料查看。<br>防御思路有：</li>
</ol>
<ul>
<li>用户资源ID（订单ID、地址ID等）绑定到用户，只允许有权限的用户查看。</li>
<li>当前用户信息存储到session，不放在request中，避免攻击者修改。</li>
</ul>
<h4 id="投票-积分-抽奖"><a href="#投票-积分-抽奖" class="headerlink" title="投票/积分/抽奖"></a>投票/积分/抽奖</h4><p>共同点：<code>单个用户次数存在限制</code>，该限制存在很多绕过方式。<br>通常有几种利用方法：</p>
<ol>
<li>cookie或POST请求正文绕过。修改cookie或post请求数据产生绕过。</li>
<li>基于IP验证。看程序获取IP的方式，如果是client-ip或x_forward_for获取IP，可直接伪造IP绕过。</li>
<li>基于用户认证。利用批量注册刷票，或在投票时随意修改POST包或cookie里的当前uid、用户名等查看是否能够绕过限制。<br>从上述利用手段可以看到主要三个点是IP、登录用户、cookie，可用性比较高的防御手段如下：</li>
<li>机器识别码验证。</li>
<li>操作需要登录，当前用户信息从session读取。</li>
</ol>
<h4 id="充值支付"><a href="#充值支付" class="headerlink" title="充值支付"></a>充值支付</h4><p>主要有四种情况：客户端可修改单价、总价和购买数量以及利用时间差多次购买。<br>主要应对手法是：</p>
<ol>
<li>保证数据可信，商品单价和总价不可从客户端获取。</li>
<li>购买数量不能小于等于0。</li>
<li>账户支付锁定机制，当一个支付操作开始就应该立马锁定当前用户，不能同时两个后端请求对余额进行操作。</li>
</ol>
<h4 id="私信及反馈"><a href="#私信及反馈" class="headerlink" title="私信及反馈"></a>私信及反馈</h4><p>除去特殊情况下可以滤去的SQL注入或命令执行等少见漏洞外，最常见的就是XSS漏洞以及越权漏洞。</p>
<h4 id="远程地址访问"><a href="#远程地址访问" class="headerlink" title="远程地址访问"></a>远程地址访问</h4><p>访问远程地址获取资源的功能可能会被利用（如填入内网地址）<br>利用限制填写来防御该类漏洞，但大部分厂商修复时不会考虑到短地址的问题，修复后仍然可以通过生成短链接的方式利用。</p>
<h4 id="文件管理"><a href="#文件管理" class="headerlink" title="文件管理"></a>文件管理</h4><p>本身就是一个高危功能，权限管理不当会导致被攻击者利用写入webshell。<br>为了保证安全，在满足业务需求的情况下，设计时应遵循以下几点：</p>
<ol>
<li>禁止写入脚本可在服务器端执行的文件：如服务器可解析PHP，那么此次就需要限制不能操作PHP扩展名的文件和PHP标签的代码。</li>
<li>限制文件管理功能操作的目录：限制文件管理功能只能操作固定目录，目录不能从客户端提交，在代码中设置好即可，如果实在需要进行目录跳转的话，一定要禁止提交<code>../</code>以及<code>\..</code>避免越权操作其它目录。</li>
<li>限制文件管理功能访问权限：虽然文件管理是正常功能，但存在一点后门的性质，所以对该功能的访问权限一定要严格控制。</li>
<li>禁止上传特殊字符文件名的文件：大多数应用会对上传文件进行展示，特别是网盘类应用，注意对上传文件名进行检查，禁止文件名中有尖括号、单双引号等特殊字符，避免攻击者用文件名进行XSS攻击。</li>
</ol>
<h4 id="数据库管理"><a href="#数据库管理" class="headerlink" title="数据库管理"></a>数据库管理</h4><p>跟文件管理一样，也是高位功能，如果启动数据库服务的系统用户以及数据库用户的权限都够大，完全可以利用该功能直接执行系统命令及操作服务器上的文件。</p>
<ol>
<li>限制可以操作的数据库表，要么在代码内写死只能操作哪些表（如备份），如果是执行SQL语句的方式可以另建一个mysql用户，限制可操作的表和字段。</li>
<li>限制备份到服务器上的文件名，需要随机生成且长度不低于16位，扩展名不能自定义，防止攻击者利用该功能导出webshell或猜解文件名直接下载。</li>
</ol>
<h4 id="命令-代码执行"><a href="#命令-代码执行" class="headerlink" title="命令/代码执行"></a>命令/代码执行</h4><p>命令执行和代码执行功能通常都在系统后台，相比来说，命令执行的功能使用更多，代码执行功能在特殊应用上才会存在。设计该类功能时应该注意以下几点：</p>
<ol>
<li>严格控制该功能访问权限，建议高权限才能访问。</li>
<li>在满足业务需求的情况下，可以设置命令白名单，可以使用escapeshellcmd()以及escapeshellarg()函数进行过滤，命令直接写死在代码中更好。</li>
<li>给命令及代码执行功能设置独立密码。</li>
<li>代码执行功能限制脚本可访问的路径。</li>
<li>在满足需求的情况下限制当前执行命令的系统权限。</li>
</ol>
<h4 id="文件-数据库备份"><a href="#文件-数据库备份" class="headerlink" title="文件/数据库备份"></a>文件/数据库备份</h4><p>是非常常见且非常容易出现安全问题的功能。常见问题有：</p>
<ol>
<li>未授权访问和越权访问：未授权访问体现在这个备份功能直接在不登录或登录验证存在漏洞的情况下可以直接使用，以及存在CSRF漏洞可以直接劫持管理员帐号进行备份。</li>
<li>备份文件名可预测：攻击者可以利用枚举的方式扫描备份包。</li>
<li>生成的文件可利用web中间件解析漏洞执行代码<br>如何设计备份功能：</li>
<li>进行权限控制，只有高权限可以使用。</li>
<li>文件名随机生成，不可预测。</li>
</ol>
<h4 id="API"><a href="#API" class="headerlink" title="API"></a>API</h4><p>因为爬虫无法抓取APP中的API接口，所以接口的SQL注入等漏洞相对较多，目前最多的问题是未授权访问以及数据遍历漏洞。因此设计一个安全的API需要从以下几点考虑：</p>
<ol>
<li>访问权限控制：必要时加入账户体系，严格控制数据调用权限，比如当前用户必须在登录情况下，接口参数中传入自己登录成功的凭证才能调用这个用户的数据。另外不需要账户体系时也要注意加入不可暴力破解的访问密钥进行权限验证。</li>
<li>防止敏感信息泄漏：没必要输出的信息应该注意禁止输出。</li>
<li>SQL注入等常规漏洞：注意代码安全，防止SQL注入、代码执行等漏洞的产生。</li>
</ol>
<h3 id="应用安全体系建设"><a href="#应用安全体系建设" class="headerlink" title="应用安全体系建设"></a>应用安全体系建设</h3><ol>
<li>用户密码安全策略</li>
<li>前后台用户分表：同表的情况下可能存在越权修改管理员信息等情况。</li>
<li>后台地址隐藏</li>
<li>密码加密存储方式</li>
<li>登录限制</li>
<li>API站库分离</li>
<li>慎用第三方服务</li>
<li>严格的权限控制</li>
<li>敏感操作多因素验证</li>
<li>应用自身的安全中心</li>
</ol>

            </div>
        
        <footer class="article-footer">
        </footer>
    </div>
</article>






    
        <nav id="page-nav">
        <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/">Next &amp;raquo;</a>
        </nav>
    
</section>
        </div>
        <footer id="footer">
    <div class="outer">
        <div id="footer-info" class="inner">
            Tsunamori &copy; 2023 
            <a rel="external nofollow noopener noreferrer" target="_blank" href="http://creativecommons.org/licenses/by-nc-nd/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-nd/4.0/80x15.png"></a>
            <br> Powered by <a href="http://hexo.io/" target="_blank" rel="external nofollow noopener noreferrer">Hexo</a>. Theme - <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/zthxxx/hexo-theme-Wikitten">wikitten</a>
            
                <br>
                <span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i> <span id="busuanzi_value_site_pv"></span></span>
                &nbsp;|&nbsp;
                <span id="busuanzi_container_site_pv"><i class="fa fa-user"></i> <span id="busuanzi_value_site_uv"></span></span>
            
        </div>
    </div>
</footer>

        

    
        
<script src="/libs/lightgallery/js/lightgallery.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-pager.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-autoplay.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-zoom.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-hash.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-share.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-video.min.js"></script>

    
    
        
<script src="/libs/justified-gallery/jquery.justifiedGallery.min.js"></script>

    
    
        <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true,
            TeX: {
                equationNumbers: {
                  autoNumber: 'AMS'
                }
            }
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    



<!-- Custom Scripts -->

<script src="/js/main.js"></script>


    </div>
</body>
</html>